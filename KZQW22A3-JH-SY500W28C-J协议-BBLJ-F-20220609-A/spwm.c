 #include "hand_tble.h" 


u8 dir_ver_count;

const u16 hall_ver_step_table[4201] = {
0	,
1571840	,
785920	,
523946	,
392960	,
314368	,
261973	,
224548	,
196480	,
174648	,
157184	,
142894	,
130986	,
120910	,
112274	,
104789	,
98240	,
92461	,
87324	,
82728	,
78592	,
74849	,
71447	,
68340	,
65493	,
62873	,
60455	,
58216	,
56137	,
54201	,
52394	,
50704	,
49120	,
47631	,
46230	,
44909	,
43662	,
42482	,
41364	,
40303	,
39296	,
38337	,
37424	,
36554	,
35723	,
34929	,
34170	,
33443	,
32746	,
32078	,
31436	,
30820	,
30227	,
29657	,
29108	,
28578	,
28068	,
27576	,
27100	,
26641	,
26197	,
25767	,
25352	,
24949	,
24560	,
24182	,
23815	,
23460	,
23115	,
22780	,
22454	,
22138	,
21831	,
21532	,
21241	,
20957	,
20682	,
20413	,
20151	,
19896	,
19648	,
19405	,
19168	,
18937	,
18712	,
18492	,
18277	,
18067	,
17861	,
17661	,
17464	,
17272	,
17085	,
16901	,
16721	,
16545	,
16373	,
16204	,
16039	,
15877	,
15718	,
15562	,
15410	,
15260	,
15113	,
14969	,
14828	,
14690	,
14554	,
14420	,
14289	,
14160	,
14034	,
13910	,
13788	,
13668	,
13550	,
13434	,
13320	,
13208	,
13098	,
12990	,
12883	,
12779	,
12676	,
12574	,
12474	,
12376	,
12280	,
12184	,
12091	,
11998	,
11907	,
11818	,
11730	,
11643	,
11557	,
11473	,
11390	,
11308	,
11227	,
11147	,
11069	,
10991	,
10915	,
10840	,
10766	,
10692	,
10620	,
10549	,
10478	,
10409	,
10341	,
10273	,
10206	,
10140	,
10075	,
10011	,
9948	,
9885	,
9824	,
9762	,
9702	,
9643	,
9584	,
9526	,
9468	,
9412	,
9356	,
9300	,
9246	,
9192	,
9138	,
9085	,
9033	,
8981	,
8930	,
8880	,
8830	,
8781	,
8732	,
8684	,
8636	,
8589	,
8542	,
8496	,
8450	,
8405	,
8360	,
8316	,
8272	,
8229	,
8186	,
8144	,
8102	,
8060	,
8019	,
7978	,
7938	,
7898	,
7859	,
7820	,
7781	,
7743	,
7705	,
7667	,
7630	,
7593	,
7556	,
7520	,
7484	,
7449	,
7414	,
7379	,
7345	,
7310	,
7277	,
7243	,
7210	,
7177	,
7144	,
7112	,
7080	,
7048	,
7017	,
6985	,
6955	,
6924	,
6894	,
6863	,
6834	,
6804	,
6775	,
6746	,
6717	,
6688	,
6660	,
6632	,
6604	,
6576	,
6549	,
6522	,
6495	,
6468	,
6441	,
6415	,
6389	,
6363	,
6338	,
6312	,
6287	,
6262	,
6237	,
6212	,
6188	,
6164	,
6140	,
6116	,
6092	,
6068	,
6045	,
6022	,
5999	,
5976	,
5953	,
5931	,
5909	,
5887	,
5865	,
5843	,
5821	,
5800	,
5778	,
5757	,
5736	,
5715	,
5695	,
5674	,
5654	,
5633	,
5613	,
5593	,
5573	,
5554	,
5534	,
5515	,
5495	,
5476	,
5457	,
5438	,
5420	,
5401	,
5383	,
5364	,
5346	,
5328	,
5310	,
5292	,
5274	,
5256	,
5239	,
5222	,
5204	,
5187	,
5170	,
5153	,
5136	,
5120	,
5103	,
5086	,
5070	,
5054	,
5037	,
5021	,
5005	,
4989	,
4974	,
4958	,
4942	,
4927	,
4912	,
4896	,
4881	,
4866	,
4851	,
4836	,
4821	,
4806	,
4792	,
4777	,
4763	,
4748	,
4734	,
4720	,
4706	,
4692	,
4678	,
4664	,
4650	,
4636	,
4623	,
4609	,
4596	,
4582	,
4569	,
4556	,
4542	,
4529	,
4516	,
4503	,
4490	,
4478	,
4465	,
4452	,
4440	,
4427	,
4415	,
4402	,
4390	,
4378	,
4366	,
4354	,
4342	,
4330	,
4318	,
4306	,
4294	,
4282	,
4271	,
4259	,
4248	,
4236	,
4225	,
4214	,
4202	,
4191	,
4180	,
4169	,
4158	,
4147	,
4136	,
4125	,
4114	,
4104	,
4093	,
4082	,
4072	,
4061	,
4051	,
4040	,
4030	,
4020	,
4009	,
3999	,
3989	,
3979	,
3969	,
3959	,
3949	,
3939	,
3929	,
3919	,
3910	,
3900	,
3890	,
3881	,
3871	,
3862	,
3852	,
3843	,
3833	,
3824	,
3815	,
3805	,
3796	,
3787	,
3778	,
3769	,
3760	,
3751	,
3742	,
3733	,
3724	,
3715	,
3707	,
3698	,
3689	,
3681	,
3672	,
3663	,
3655	,
3646	,
3638	,
3630	,
3621	,
3613	,
3605	,
3596	,
3588	,
3580	,
3572	,
3564	,
3556	,
3548	,
3540	,
3532	,
3524	,
3516	,
3508	,
3500	,
3492	,
3485	,
3477	,
3469	,
3462	,
3454	,
3447	,
3439	,
3431	,
3424	,
3417	,
3409	,
3402	,
3394	,
3387	,
3380	,
3373	,
3365	,
3358	,
3351	,
3344	,
3337	,
3330	,
3323	,
3316	,
3309	,
3302	,
3295	,
3288	,
3281	,
3274	,
3267	,
3261	,
3254	,
3247	,
3240	,
3234	,
3227	,
3220	,
3214	,
3207	,
3201	,
3194	,
3188	,
3181	,
3175	,
3169	,
3162	,
3156	,
3149	,
3143	,
3137	,
3131	,
3124	,
3118	,
3112	,
3106	,
3100	,
3094	,
3088	,
3082	,
3076	,
3070	,
3064	,
3058	,
3052	,
3046	,
3040	,
3034	,
3028	,
3022	,
3016	,
3011	,
3005	,
2999	,
2993	,
2988	,
2982	,
2976	,
2971	,
2965	,
2960	,
2954	,
2949	,
2943	,
2938	,
2932	,
2927	,
2921	,
2916	,
2910	,
2905	,
2900	,
2894	,
2889	,
2884	,
2878	,
2873	,
2868	,
2863	,
2857	,
2852	,
2847	,
2842	,
2837	,
2832	,
2827	,
2821	,
2816	,
2811	,
2806	,
2801	,
2796	,
2791	,
2786	,
2782	,
2777	,
2772	,
2767	,
2762	,
2757	,
2752	,
2747	,
2743	,
2738	,
2733	,
2728	,
2724	,
2719	,
2714	,
2710	,
2705	,
2700	,
2696	,
2691	,
2686	,
2682	,
2677	,
2673	,
2668	,
2664	,
2659	,
2655	,
2650	,
2646	,
2641	,
2637	,
2632	,
2628	,
2624	,
2619	,
2615	,
2611	,
2606	,
2602	,
2598	,
2593	,
2589	,
2585	,
2581	,
2576	,
2572	,
2568	,
2564	,
2560	,
2555	,
2551	,
2547	,
2543	,
2539	,
2535	,
2531	,
2527	,
2523	,
2518	,
2514	,
2510	,
2506	,
2502	,
2498	,
2494	,
2491	,
2487	,
2483	,
2479	,
2475	,
2471	,
2467	,
2463	,
2459	,
2456	,
2452	,
2448	,
2444	,
2440	,
2436	,
2433	,
2429	,
2425	,
2421	,
2418	,
2414	,
2410	,
2407	,
2403	,
2399	,
2396	,
2392	,
2388	,
2385	,
2381	,
2377	,
2374	,
2370	,
2367	,
2363	,
2360	,
2356	,
2353	,
2349	,
2346	,
2342	,
2339	,
2335	,
2332	,
2328	,
2325	,
2321	,
2318	,
2314	,
2311	,
2308	,
2304	,
2301	,
2298	,
2294	,
2291	,
2287	,
2284	,
2281	,
2278	,
2274	,
2271	,
2268	,
2264	,
2261	,
2258	,
2255	,
2251	,
2248	,
2245	,
2242	,
2239	,
2235	,
2232	,
2229	,
2226	,
2223	,
2220	,
2216	,
2213	,
2210	,
2207	,
2204	,
2201	,
2198	,
2195	,
2192	,
2189	,
2186	,
2183	,
2180	,
2177	,
2174	,
2171	,
2168	,
2165	,
2162	,
2159	,
2156	,
2153	,
2150	,
2147	,
2144	,
2141	,
2138	,
2135	,
2132	,
2129	,
2126	,
2124	,
2121	,
2118	,
2115	,
2112	,
2109	,
2107	,
2104	,
2101	,
2098	,
2095	,
2092	,
2090	,
2087	,
2084	,
2081	,
2079	,
2076	,
2073	,
2070	,
2068	,
2065	,
2062	,
2060	,
2057	,
2054	,
2052	,
2049	,
2046	,
2044	,
2041	,
2038	,
2036	,
2033	,
2030	,
2028	,
2025	,
2022	,
2020	,
2017	,
2015	,
2012	,
2010	,
2007	,
2004	,
2002	,
1999	,
1997	,
1994	,
1992	,
1989	,
1987	,
1984	,
1982	,
1979	,
1977	,
1974	,
1972	,
1969	,
1967	,
1964	,
1962	,
1959	,
1957	,
1955	,
1952	,
1950	,
1947	,
1945	,
1942	,
1940	,
1938	,
1935	,
1933	,
1931	,
1928	,
1926	,
1923	,
1921	,
1919	,
1916	,
1914	,
1912	,
1909	,
1907	,
1905	,
1902	,
1900	,
1898	,
1896	,
1893	,
1891	,
1889	,
1886	,
1884	,
1882	,
1880	,
1877	,
1875	,
1873	,
1871	,
1869	,
1866	,
1864	,
1862	,
1860	,
1857	,
1855	,
1853	,
1851	,
1849	,
1847	,
1844	,
1842	,
1840	,
1838	,
1836	,
1834	,
1831	,
1829	,
1827	,
1825	,
1823	,
1821	,
1819	,
1817	,
1815	,
1812	,
1810	,
1808	,
1806	,
1804	,
1802	,
1800	,
1798	,
1796	,
1794	,
1792	,
1790	,
1788	,
1786	,
1784	,
1782	,
1780	,
1778	,
1776	,
1774	,
1772	,
1770	,
1768	,
1766	,
1764	,
1762	,
1760	,
1758	,
1756	,
1754	,
1752	,
1750	,
1748	,
1746	,
1744	,
1742	,
1740	,
1738	,
1736	,
1734	,
1733	,
1731	,
1729	,
1727	,
1725	,
1723	,
1721	,
1719	,
1717	,
1715	,
1714	,
1712	,
1710	,
1708	,
1706	,
1704	,
1702	,
1701	,
1699	,
1697	,
1695	,
1693	,
1691	,
1690	,
1688	,
1686	,
1684	,
1682	,
1681	,
1679	,
1677	,
1675	,
1673	,
1672	,
1670	,
1668	,
1666	,
1665	,
1663	,
1661	,
1659	,
1658	,
1656	,
1654	,
1652	,
1651	,
1649	,
1647	,
1645	,
1644	,
1642	,
1640	,
1639	,
1637	,
1635	,
1633	,
1632	,
1630	,
1628	,
1627	,
1625	,
1623	,
1622	,
1620	,
1618	,
1617	,
1615	,
1613	,
1612	,
1610	,
1608	,
1607	,
1605	,
1603	,
1602	,
1600	,
1599	,
1597	,
1595	,
1594	,
1592	,
1590	,
1589	,
1587	,
1586	,
1584	,
1582	,
1581	,
1579	,
1578	,
1576	,
1574	,
1573	,
1571	,
1570	,
1568	,
1567	,
1565	,
1564	,
1562	,
1560	,
1559	,
1557	,
1556	,
1554	,
1553	,
1551	,
1550	,
1548	,
1547	,
1545	,
1544	,
1542	,
1541	,
1539	,
1538	,
1536	,
1535	,
1533	,
1532	,
1530	,
1529	,
1527	,
1526	,
1524	,
1523	,
1521	,
1520	,
1518	,
1517	,
1515	,
1514	,
1512	,
1511	,
1509	,
1508	,
1507	,
1505	,
1504	,
1502	,
1501	,
1499	,
1498	,
1496	,
1495	,
1494	,
1492	,
1491	,
1489	,
1488	,
1487	,
1485	,
1484	,
1482	,
1481	,
1480	,
1478	,
1477	,
1475	,
1474	,
1473	,
1471	,
1470	,
1469	,
1467	,
1466	,
1464	,
1463	,
1462	,
1460	,
1459	,
1458	,
1456	,
1455	,
1454	,
1452	,
1451	,
1450	,
1448	,
1447	,
1446	,
1444	,
1443	,
1442	,
1440	,
1439	,
1438	,
1436	,
1435	,
1434	,
1432	,
1431	,
1430	,
1428	,
1427	,
1426	,
1425	,
1423	,
1422	,
1421	,
1419	,
1418	,
1417	,
1416	,
1414	,
1413	,
1412	,
1410	,
1409	,
1408	,
1407	,
1405	,
1404	,
1403	,
1402	,
1400	,
1399	,
1398	,
1397	,
1395	,
1394	,
1393	,
1392	,
1391	,
1389	,
1388	,
1387	,
1386	,
1384	,
1383	,
1382	,
1381	,
1380	,
1378	,
1377	,
1376	,
1375	,
1373	,
1372	,
1371	,
1370	,
1369	,
1368	,
1366	,
1365	,
1364	,
1363	,
1362	,
1360	,
1359	,
1358	,
1357	,
1356	,
1355	,
1353	,
1352	,
1351	,
1350	,
1349	,
1348	,
1346	,
1345	,
1344	,
1343	,
1342	,
1341	,
1340	,
1338	,
1337	,
1336	,
1335	,
1334	,
1333	,
1332	,
1330	,
1329	,
1328	,
1327	,
1326	,
1325	,
1324	,
1323	,
1321	,
1320	,
1319	,
1318	,
1317	,
1316	,
1315	,
1314	,
1313	,
1312	,
1310	,
1309	,
1308	,
1307	,
1306	,
1305	,
1304	,
1303	,
1302	,
1301	,
1300	,
1299	,
1297	,
1296	,
1295	,
1294	,
1293	,
1292	,
1291	,
1290	,
1289	,
1288	,
1287	,
1286	,
1285	,
1284	,
1283	,
1282	,
1281	,
1280	,
1278	,
1277	,
1276	,
1275	,
1274	,
1273	,
1272	,
1271	,
1270	,
1269	,
1268	,
1267	,
1266	,
1265	,
1264	,
1263	,
1262	,
1261	,
1260	,
1259	,
1258	,
1257	,
1256	,
1255	,
1254	,
1253	,
1252	,
1251	,
1250	,
1249	,
1248	,
1247	,
1246	,
1245	,
1244	,
1243	,
1242	,
1241	,
1240	,
1239	,
1238	,
1237	,
1236	,
1235	,
1234	,
1233	,
1232	,
1231	,
1230	,
1229	,
1228	,
1228	,
1227	,
1226	,
1225	,
1224	,
1223	,
1222	,
1221	,
1220	,
1219	,
1218	,
1217	,
1216	,
1215	,
1214	,
1213	,
1212	,
1211	,
1210	,
1210	,
1209	,
1208	,
1207	,
1206	,
1205	,
1204	,
1203	,
1202	,
1201	,
1200	,
1199	,
1198	,
1198	,
1197	,
1196	,
1195	,
1194	,
1193	,
1192	,
1191	,
1190	,
1189	,
1188	,
1188	,
1187	,
1186	,
1185	,
1184	,
1183	,
1182	,
1181	,
1180	,
1180	,
1179	,
1178	,
1177	,
1176	,
1175	,
1174	,
1173	,
1173	,
1172	,
1171	,
1170	,
1169	,
1168	,
1167	,
1166	,
1166	,
1165	,
1164	,
1163	,
1162	,
1161	,
1160	,
1160	,
1159	,
1158	,
1157	,
1156	,
1155	,
1154	,
1154	,
1153	,
1152	,
1151	,
1150	,
1149	,
1149	,
1148	,
1147	,
1146	,
1145	,
1144	,
1143	,
1143	,
1142	,
1141	,
1140	,
1139	,
1139	,
1138	,
1137	,
1136	,
1135	,
1134	,
1134	,
1133	,
1132	,
1131	,
1130	,
1130	,
1129	,
1128	,
1127	,
1126	,
1125	,
1125	,
1124	,
1123	,
1122	,
1121	,
1121	,
1120	,
1119	,
1118	,
1117	,
1117	,
1116	,
1115	,
1114	,
1113	,
1113	,
1112	,
1111	,
1110	,
1110	,
1109	,
1108	,
1107	,
1106	,
1106	,
1105	,
1104	,
1103	,
1103	,
1102	,
1101	,
1100	,
1099	,
1099	,
1098	,
1097	,
1096	,
1096	,
1095	,
1094	,
1093	,
1093	,
1092	,
1091	,
1090	,
1090	,
1089	,
1088	,
1087	,
1087	,
1086	,
1085	,
1084	,
1084	,
1083	,
1082	,
1081	,
1081	,
1080	,
1079	,
1078	,
1078	,
1077	,
1076	,
1075	,
1075	,
1074	,
1073	,
1072	,
1072	,
1071	,
1070	,
1070	,
1069	,
1068	,
1067	,
1067	,
1066	,
1065	,
1064	,
1064	,
1063	,
1062	,
1062	,
1061	,
1060	,
1059	,
1059	,
1058	,
1057	,
1057	,
1056	,
1055	,
1054	,
1054	,
1053	,
1052	,
1052	,
1051	,
1050	,
1049	,
1049	,
1048	,
1047	,
1047	,
1046	,
1045	,
1045	,
1044	,
1043	,
1043	,
1042	,
1041	,
1040	,
1040	,
1039	,
1038	,
1038	,
1037	,
1036	,
1036	,
1035	,
1034	,
1034	,
1033	,
1032	,
1032	,
1031	,
1030	,
1030	,
1029	,
1028	,
1028	,
1027	,
1026	,
1026	,
1025	,
1024	,
1024	,
1023	,
1022	,
1022	,
1021	,
1020	,
1020	,
1019	,
1018	,
1018	,
1017	,
1016	,
1016	,
1015	,
1014	,
1014	,
1013	,
1012	,
1012	,
1011	,
1010	,
1010	,
1009	,
1008	,
1008	,
1007	,
1006	,
1006	,
1005	,
1005	,
1004	,
1003	,
1003	,
1002	,
1001	,
1001	,
1000	,
999	,
999	,
998	,
997	,
997	,
996	,
996	,
995	,
994	,
994	,
993	,
992	,
992	,
991	,
991	,
990	,
989	,
989	,
988	,
987	,
987	,
986	,
986	,
985	,
984	,
984	,
983	,
983	,
982	,
981	,
981	,
980	,
979	,
979	,
978	,
978	,
977	,
976	,
976	,
975	,
975	,
974	,
973	,
973	,
972	,
972	,
971	,
970	,
970	,
969	,
969	,
968	,
967	,
967	,
966	,
966	,
965	,
964	,
964	,
963	,
963	,
962	,
961	,
961	,
960	,
960	,
959	,
959	,
958	,
957	,
957	,
956	,
956	,
955	,
954	,
954	,
953	,
953	,
952	,
952	,
951	,
950	,
950	,
949	,
949	,
948	,
948	,
947	,
946	,
946	,
945	,
945	,
944	,
944	,
943	,
942	,
942	,
941	,
941	,
940	,
940	,
939	,
938	,
938	,
937	,
937	,
936	,
936	,
935	,
935	,
934	,
933	,
933	,
932	,
932	,
931	,
931	,
930	,
930	,
929	,
928	,
928	,
927	,
927	,
926	,
926	,
925	,
925	,
924	,
924	,
923	,
922	,
922	,
921	,
921	,
920	,
920	,
919	,
919	,
918	,
918	,
917	,
917	,
916	,
915	,
915	,
914	,
914	,
913	,
913	,
912	,
912	,
911	,
911	,
910	,
910	,
909	,
909	,
908	,
908	,
907	,
907	,
906	,
905	,
905	,
904	,
904	,
903	,
903	,
902	,
902	,
901	,
901	,
900	,
900	,
899	,
899	,
898	,
898	,
897	,
897	,
896	,
896	,
895	,
895	,
894	,
894	,
893	,
893	,
892	,
892	,
891	,
891	,
890	,
890	,
889	,
889	,
888	,
888	,
887	,
887	,
886	,
886	,
885	,
885	,
884	,
884	,
883	,
883	,
882	,
882	,
881	,
881	,
880	,
880	,
879	,
879	,
878	,
878	,
877	,
877	,
876	,
876	,
875	,
875	,
874	,
874	,
873	,
873	,
872	,
872	,
871	,
871	,
870	,
870	,
869	,
869	,
868	,
868	,
867	,
867	,
866	,
866	,
866	,
865	,
865	,
864	,
864	,
863	,
863	,
862	,
862	,
861	,
861	,
860	,
860	,
859	,
859	,
858	,
858	,
857	,
857	,
857	,
856	,
856	,
855	,
855	,
854	,
854	,
853	,
853	,
852	,
852	,
851	,
851	,
851	,
850	,
850	,
849	,
849	,
848	,
848	,
847	,
847	,
846	,
846	,
845	,
845	,
845	,
844	,
844	,
843	,
843	,
842	,
842	,
841	,
841	,
841	,
840	,
840	,
839	,
839	,
838	,
838	,
837	,
837	,
836	,
836	,
836	,
835	,
835	,
834	,
834	,
833	,
833	,
832	,
832	,
832	,
831	,
831	,
830	,
830	,
829	,
829	,
829	,
828	,
828	,
827	,
827	,
826	,
826	,
825	,
825	,
825	,
824	,
824	,
823	,
823	,
822	,
822	,
822	,
821	,
821	,
820	,
820	,
819	,
819	,
819	,
818	,
818	,
817	,
817	,
816	,
816	,
816	,
815	,
815	,
814	,
814	,
814	,
813	,
813	,
812	,
812	,
811	,
811	,
811	,
810	,
810	,
809	,
809	,
808	,
808	,
808	,
807	,
807	,
806	,
806	,
806	,
805	,
805	,
804	,
804	,
804	,
803	,
803	,
802	,
802	,
801	,
801	,
801	,
800	,
800	,
799	,
799	,
799	,
798	,
798	,
797	,
797	,
797	,
796	,
796	,
795	,
795	,
795	,
794	,
794	,
793	,
793	,
793	,
792	,
792	,
791	,
791	,
791	,
790	,
790	,
789	,
789	,
789	,
788	,
788	,
787	,
787	,
787	,
786	,
786	,
785	,
785	,
785	,
784	,
784	,
783	,
783	,
783	,
782	,
782	,
782	,
781	,
781	,
780	,
780	,
780	,
779	,
779	,
778	,
778	,
778	,
777	,
777	,
776	,
776	,
776	,
775	,
775	,
775	,
774	,
774	,
773	,
773	,
773	,
772	,
772	,
772	,
771	,
771	,
770	,
770	,
770	,
769	,
769	,
769	,
768	,
768	,
767	,
767	,
767	,
766	,
766	,
766	,
765	,
765	,
764	,
764	,
764	,
763	,
763	,
763	,
762	,
762	,
761	,
761	,
761	,
760	,
760	,
760	,
759	,
759	,
758	,
758	,
758	,
757	,
757	,
757	,
756	,
756	,
756	,
755	,
755	,
754	,
754	,
754	,
753	,
753	,
753	,
752	,
752	,
752	,
751	,
751	,
750	,
750	,
750	,
749	,
749	,
749	,
748	,
748	,
748	,
747	,
747	,
747	,
746	,
746	,
746	,
745	,
745	,
744	,
744	,
744	,
743	,
743	,
743	,
742	,
742	,
742	,
741	,
741	,
741	,
740	,
740	,
740	,
739	,
739	,
738	,
738	,
738	,
737	,
737	,
737	,
736	,
736	,
736	,
735	,
735	,
735	,
734	,
734	,
734	,
733	,
733	,
733	,
732	,
732	,
732	,
731	,
731	,
731	,
730	,
730	,
730	,
729	,
729	,
729	,
728	,
728	,
728	,
727	,
727	,
727	,
726	,
726	,
726	,
725	,
725	,
725	,
724	,
724	,
724	,
723	,
723	,
723	,
722	,
722	,
722	,
721	,
721	,
721	,
720	,
720	,
720	,
719	,
719	,
719	,
718	,
718	,
718	,
717	,
717	,
717	,
716	,
716	,
716	,
715	,
715	,
715	,
714	,
714	,
714	,
713	,
713	,
713	,
712	,
712	,
712	,
711	,
711	,
711	,
710	,
710	,
710	,
709	,
709	,
709	,
708	,
708	,
708	,
708	,
707	,
707	,
707	,
706	,
706	,
706	,
705	,
705	,
705	,
704	,
704	,
704	,
703	,
703	,
703	,
702	,
702	,
702	,
702	,
701	,
701	,
701	,
700	,
700	,
700	,
699	,
699	,
699	,
698	,
698	,
698	,
697	,
697	,
697	,
697	,
696	,
696	,
696	,
695	,
695	,
695	,
694	,
694	,
694	,
693	,
693	,
693	,
693	,
692	,
692	,
692	,
691	,
691	,
691	,
690	,
690	,
690	,
690	,
689	,
689	,
689	,
688	,
688	,
688	,
687	,
687	,
687	,
686	,
686	,
686	,
686	,
685	,
685	,
685	,
684	,
684	,
684	,
684	,
683	,
683	,
683	,
682	,
682	,
682	,
681	,
681	,
681	,
681	,
680	,
680	,
680	,
679	,
679	,
679	,
678	,
678	,
678	,
678	,
677	,
677	,
677	,
676	,
676	,
676	,
676	,
675	,
675	,
675	,
674	,
674	,
674	,
674	,
673	,
673	,
673	,
672	,
672	,
672	,
672	,
671	,
671	,
671	,
670	,
670	,
670	,
670	,
669	,
669	,
669	,
668	,
668	,
668	,
668	,
667	,
667	,
667	,
666	,
666	,
666	,
666	,
665	,
665	,
665	,
664	,
664	,
664	,
664	,
663	,
663	,
663	,
662	,
662	,
662	,
662	,
661	,
661	,
661	,
660	,
660	,
660	,
660	,
659	,
659	,
659	,
659	,
658	,
658	,
658	,
657	,
657	,
657	,
657	,
656	,
656	,
656	,
656	,
655	,
655	,
655	,
654	,
654	,
654	,
654	,
653	,
653	,
653	,
653	,
652	,
652	,
652	,
651	,
651	,
651	,
651	,
650	,
650	,
650	,
650	,
649	,
649	,
649	,
648	,
648	,
648	,
648	,
647	,
647	,
647	,
647	,
646	,
646	,
646	,
646	,
645	,
645	,
645	,
644	,
644	,
644	,
644	,
643	,
643	,
643	,
643	,
642	,
642	,
642	,
642	,
641	,
641	,
641	,
641	,
640	,
640	,
640	,
640	,
639	,
639	,
639	,
638	,
638	,
638	,
638	,
637	,
637	,
637	,
637	,
636	,
636	,
636	,
636	,
635	,
635	,
635	,
635	,
634	,
634	,
634	,
634	,
633	,
633	,
633	,
633	,
632	,
632	,
632	,
632	,
631	,
631	,
631	,
631	,
630	,
630	,
630	,
629	,
629	,
629	,
629	,
628	,
628	,
628	,
628	,
627	,
627	,
627	,
627	,
626	,
626	,
626	,
626	,
625	,
625	,
625	,
625	,
624	,
624	,
624	,
624	,
623	,
623	,
623	,
623	,
623	,
622	,
622	,
622	,
622	,
621	,
621	,
621	,
621	,
620	,
620	,
620	,
620	,
619	,
619	,
619	,
619	,
618	,
618	,
618	,
618	,
617	,
617	,
617	,
617	,
616	,
616	,
616	,
616	,
615	,
615	,
615	,
615	,
614	,
614	,
614	,
614	,
614	,
613	,
613	,
613	,
613	,
612	,
612	,
612	,
612	,
611	,
611	,
611	,
611	,
610	,
610	,
610	,
610	,
609	,
609	,
609	,
609	,
609	,
608	,
608	,
608	,
608	,
607	,
607	,
607	,
607	,
606	,
606	,
606	,
606	,
605	,
605	,
605	,
605	,
605	,
604	,
604	,
604	,
604	,
603	,
603	,
603	,
603	,
602	,
602	,
602	,
602	,
602	,
601	,
601	,
601	,
601	,
600	,
600	,
600	,
600	,
599	,
599	,
599	,
599	,
599	,
598	,
598	,
598	,
598	,
597	,
597	,
597	,
597	,
596	,
596	,
596	,
596	,
596	,
595	,
595	,
595	,
595	,
594	,
594	,
594	,
594	,
594	,
593	,
593	,
593	,
593	,
592	,
592	,
592	,
592	,
592	,
591	,
591	,
591	,
591	,
590	,
590	,
590	,
590	,
590	,
589	,
589	,
589	,
589	,
588	,
588	,
588	,
588	,
588	,
587	,
587	,
587	,
587	,
586	,
586	,
586	,
586	,
586	,
585	,
585	,
585	,
585	,
584	,
584	,
584	,
584	,
584	,
583	,
583	,
583	,
583	,
583	,
582	,
582	,
582	,
582	,
581	,
581	,
581	,
581	,
581	,
580	,
580	,
580	,
580	,
580	,
579	,
579	,
579	,
579	,
578	,
578	,
578	,
578	,
578	,
577	,
577	,
577	,
577	,
577	,
576	,
576	,
576	,
576	,
575	,
575	,
575	,
575	,
575	,
574	,
574	,
574	,
574	,
574	,
573	,
573	,
573	,
573	,
573	,
572	,
572	,
572	,
572	,
571	,
571	,
571	,
571	,
571	,
570	,
570	,
570	,
570	,
570	,
569	,
569	,
569	,
569	,
569	,
568	,
568	,
568	,
568	,
568	,
567	,
567	,
567	,
567	,
567	,
566	,
566	,
566	,
566	,
566	,
565	,
565	,
565	,
565	,
565	,
564	,
564	,
564	,
564	,
563	,
563	,
563	,
563	,
563	,
562	,
562	,
562	,
562	,
562	,
561	,
561	,
561	,
561	,
561	,
560	,
560	,
560	,
560	,
560	,
559	,
559	,
559	,
559	,
559	,
558	,
558	,
558	,
558	,
558	,
557	,
557	,
557	,
557	,
557	,
556	,
556	,
556	,
556	,
556	,
556	,
555	,
555	,
555	,
555	,
555	,
554	,
554	,
554	,
554	,
554	,
553	,
553	,
553	,
553	,
553	,
552	,
552	,
552	,
552	,
552	,
551	,
551	,
551	,
551	,
551	,
550	,
550	,
550	,
550	,
550	,
549	,
549	,
549	,
549	,
549	,
549	,
548	,
548	,
548	,
548	,
548	,
547	,
547	,
547	,
547	,
547	,
546	,
546	,
546	,
546	,
546	,
545	,
545	,
545	,
545	,
545	,
545	,
544	,
544	,
544	,
544	,
544	,
543	,
543	,
543	,
543	,
543	,
542	,
542	,
542	,
542	,
542	,
542	,
541	,
541	,
541	,
541	,
541	,
540	,
540	,
540	,
540	,
540	,
539	,
539	,
539	,
539	,
539	,
539	,
538	,
538	,
538	,
538	,
538	,
537	,
537	,
537	,
537	,
537	,
537	,
536	,
536	,
536	,
536	,
536	,
535	,
535	,
535	,
535	,
535	,
535	,
534	,
534	,
534	,
534	,
534	,
533	,
533	,
533	,
533	,
533	,
533	,
532	,
532	,
532	,
532	,
532	,
531	,
531	,
531	,
531	,
531	,
531	,
530	,
530	,
530	,
530	,
530	,
529	,
529	,
529	,
529	,
529	,
529	,
528	,
528	,
528	,
528	,
528	,
527	,
527	,
527	,
527	,
527	,
527	,
526	,
526	,
526	,
526	,
526	,
526	,
525	,
525	,
525	,
525	,
525	,
524	,
524	,
524	,
524	,
524	,
524	,
523	,
523	,
523	,
523	,
523	,
523	,
522	,
522	,
522	,
522	,
522	,
522	,
521	,
521	,
521	,
521	,
521	,
520	,
520	,
520	,
520	,
520	,
520	,
519	,
519	,
519	,
519	,
519	,
519	,
518	,
518	,
518	,
518	,
518	,
518	,
517	,
517	,
517	,
517	,
517	,
517	,
516	,
516	,
516	,
516	,
516	,
516	,
515	,
515	,
515	,
515	,
515	,
515	,
514	,
514	,
514	,
514	,
514	,
514	,
513	,
513	,
513	,
513	,
513	,
513	,
512	,
512	,
512	,
512	,
512	,
512	,
511	,
511	,
511	,
511	,
511	,
511	,
510	,
510	,
510	,
510	,
510	,
510	,
509	,
509	,
509	,
509	,
509	,
509	,
508	,
508	,
508	,
508	,
508	,
508	,
507	,
507	,
507	,
507	,
507	,
507	,
506	,
506	,
506	,
506	,
506	,
506	,
505	,
505	,
505	,
505	,
505	,
505	,
504	,
504	,
504	,
504	,
504	,
504	,
503	,
503	,
503	,
503	,
503	,
503	,
502	,
502	,
502	,
502	,
502	,
502	,
502	,
501	,
501	,
501	,
501	,
501	,
501	,
500	,
500	,
500	,
500	,
500	,
500	,
499	,
499	,
499	,
499	,
499	,
499	,
498	,
498	,
498	,
498	,
498	,
498	,
498	,
497	,
497	,
497	,
497	,
497	,
497	,
496	,
496	,
496	,
496	,
496	,
496	,
496	,
495	,
495	,
495	,
495	,
495	,
495	,
494	,
494	,
494	,
494	,
494	,
494	,
493	,
493	,
493	,
493	,
493	,
493	,
493	,
492	,
492	,
492	,
492	,
492	,
492	,
491	,
491	,
491	,
491	,
491	,
491	,
491	,
490	,
490	,
490	,
490	,
490	,
490	,
489	,
489	,
489	,
489	,
489	,
489	,
489	,
488	,
488	,
488	,
488	,
488	,
488	,
487	,
487	,
487	,
487	,
487	,
487	,
487	,
486	,
486	,
486	,
486	,
486	,
486	,
486	,
485	,
485	,
485	,
485	,
485	,
485	,
484	,
484	,
484	,
484	,
484	,
484	,
484	,
483	,
483	,
483	,
483	,
483	,
483	,
483	,
482	,
482	,
482	,
482	,
482	,
482	,
482	,
481	,
481	,
481	,
481	,
481	,
481	,
480	,
480	,
480	,
480	,
480	,
480	,
480	,
479	,
479	,
479	,
479	,
479	,
479	,
479	,
478	,
478	,
478	,
478	,
478	,
478	,
478	,
477	,
477	,
477	,
477	,
477	,
477	,
477	,
476	,
476	,
476	,
476	,
476	,
476	,
476	,
475	,
475	,
475	,
475	,
475	,
475	,
475	,
474	,
474	,
474	,
474	,
474	,
474	,
474	,
473	,
473	,
473	,
473	,
473	,
473	,
473	,
472	,
472	,
472	,
472	,
472	,
472	,
472	,
471	,
471	,
471	,
471	,
471	,
471	,
471	,
470	,
470	,
470	,
470	,
470	,
470	,
470	,
469	,
469	,
469	,
469	,
469	,
469	,
469	,
468	,
468	,
468	,
468	,
468	,
468	,
468	,
467	,
467	,
467	,
467	,
467	,
467	,
467	,
466	,
466	,
466	,
466	,
466	,
466	,
466	,
466	,
465	,
465	,
465	,
465	,
465	,
465	,
465	,
464	,
464	,
464	,
464	,
464	,
464	,
464	,
463	,
463	,
463	,
463	,
463	,
463	,
463	,
462	,
462	,
462	,
462	,
462	,
462	,
462	,
462	,
461	,
461	,
461	,
461	,
461	,
461	,
461	,
460	,
460	,
460	,
460	,
460	,
460	,
460	,
460	,
459	,
459	,
459	,
459	,
459	,
459	,
459	,
458	,
458	,
458	,
458	,
458	,
458	,
458	,
457	,
457	,
457	,
457	,
457	,
457	,
457	,
457	,
456	,
456	,
456	,
456	,
456	,
456	,
456	,
456	,
455	,
455	,
455	,
455	,
455	,
455	,
455	,
454	,
454	,
454	,
454	,
454	,
454	,
454	,
454	,
453	,
453	,
453	,
453	,
453	,
453	,
453	,
452	,
452	,
452	,
452	,
452	,
452	,
452	,
452	,
451	,
451	,
451	,
451	,
451	,
451	,
451	,
451	,
450	,
450	,
450	,
450	,
450	,
450	,
450	,
449	,
449	,
449	,
449	,
449	,
449	,
449	,
449	,
448	,
448	,
448	,
448	,
448	,
448	,
448	,
448	,
447	,
447	,
447	,
447	,
447	,
447	,
447	,
447	,
446	,
446	,
446	,
446	,
446	,
446	,
446	,
446	,
445	,
445	,
445	,
445	,
445	,
445	,
445	,
445	,
444	,
444	,
444	,
444	,
444	,
444	,
444	,
444	,
443	,
443	,
443	,
443	,
443	,
443	,
443	,
443	,
442	,
442	,
442	,
442	,
442	,
442	,
442	,
442	,
441	,
441	,
441	,
441	,
441	,
441	,
441	,
441	,
440	,
440	,
440	,
440	,
440	,
440	,
440	,
440	,
439	,
439	,
439	,
439	,
439	,
439	,
439	,
439	,
438	,
438	,
438	,
438	,
438	,
438	,
438	,
438	,
437	,
437	,
437	,
437	,
437	,
437	,
437	,
437	,
436	,
436	,
436	,
436	,
436	,
436	,
436	,
436	,
436	,
435	,
435	,
435	,
435	,
435	,
435	,
435	,
435	,
434	,
434	,
434	,
434	,
434	,
434	,
434	,
434	,
433	,
433	,
433	,
433	,
433	,
433	,
433	,
433	,
433	,
432	,
432	,
432	,
432	,
432	,
432	,
432	,
432	,
431	,
431	,
431	,
431	,
431	,
431	,
431	,
431	,
430	,
430	,
430	,
430	,
430	,
430	,
430	,
430	,
430	,
429	,
429	,
429	,
429	,
429	,
429	,
429	,
429	,
428	,
428	,
428	,
428	,
428	,
428	,
428	,
428	,
428	,
427	,
427	,
427	,
427	,
427	,
427	,
427	,
427	,
427	,
426	,
426	,
426	,
426	,
426	,
426	,
426	,
426	,
425	,
425	,
425	,
425	,
425	,
425	,
425	,
425	,
425	,
424	,
424	,
424	,
424	,
424	,
424	,
424	,
424	,
424	,
423	,
423	,
423	,
423	,
423	,
423	,
423	,
423	,
422	,
422	,
422	,
422	,
422	,
422	,
422	,
422	,
422	,
421	,
421	,
421	,
421	,
421	,
421	,
421	,
421	,
421	,
420	,
420	,
420	,
420	,
420	,
420	,
420	,
420	,
420	,
419	,
419	,
419	,
419	,
419	,
419	,
419	,
419	,
419	,
418	,
418	,
418	,
418	,
418	,
418	,
418	,
418	,
418	,
417	,
417	,
417	,
417	,
417	,
417	,
417	,
417	,
417	,
416	,
416	,
416	,
416	,
416	,
416	,
416	,
416	,
416	,
415	,
415	,
415	,
415	,
415	,
415	,
415	,
415	,
415	,
414	,
414	,
414	,
414	,
414	,
414	,
414	,
414	,
414	,
413	,
413	,
413	,
413	,
413	,
413	,
413	,
413	,
413	,
412	,
412	,
412	,
412	,
412	,
412	,
412	,
412	,
412	,
412	,
411	,
411	,
411	,
411	,
411	,
411	,
411	,
411	,
411	,
410	,
410	,
410	,
410	,
410	,
410	,
410	,
410	,
410	,
409	,
409	,
409	,
409	,
409	,
409	,
409	,
409	,
409	,
409	,
408	,
408	,
408	,
408	,
408	,
408	,
408	,
408	,
408	,
407	,
407	,
407	,
407	,
407	,
407	,
407	,
407	,
407	,
407	,
406	,
406	,
406	,
406	,
406	,
406	,
406	,
406	,
406	,
405	,
405	,
405	,
405	,
405	,
405	,
405	,
405	,
405	,
405	,
404	,
404	,
404	,
404	,
404	,
404	,
404	,
404	,
404	,
403	,
403	,
403	,
403	,
403	,
403	,
403	,
403	,
403	,
403	,
402	,
402	,
402	,
402	,
402	,
402	,
402	,
402	,
402	,
402	,
401	,
401	,
401	,
401	,
401	,
401	,
401	,
401	,
401	,
400	,
400	,
400	,
400	,
400	,
400	,
400	,
400	,
400	,
400	,
399	,
399	,
399	,
399	,
399	,
399	,
399	,
399	,
399	,
399	,
398	,
398	,
398	,
398	,
398	,
398	,
398	,
398	,
398	,
398	,
397	,
397	,
397	,
397	,
397	,
397	,
397	,
397	,
397	,
397	,
396	,
396	,
396	,
396	,
396	,
396	,
396	,
396	,
396	,
396	,
395	,
395	,
395	,
395	,
395	,
395	,
395	,
395	,
395	,
395	,
394	,
394	,
394	,
394	,
394	,
394	,
394	,
394	,
394	,
394	,
393	,
393	,
393	,
393	,
393	,
393	,
393	,
393	,
393	,
393	,
392	,
};


const u16 x255_table[256] = {
0	,
255	,
510	,
765	,
1020	,
1275	,
1530	,
1785	,
2040	,
2295	,
2550	,
2805	,
3060	,
3315	,
3570	,
3825	,
4080	,
4335	,
4590	,
4845	,
5100	,
5355	,
5610	,
5865	,
6120	,
6375	,
6630	,
6885	,
7140	,
7395	,
7650	,
7905	,
8160	,
8415	,
8670	,
8925	,
9180	,
9435	,
9690	,
9945	,
10200	,
10455	,
10710	,
10965	,
11220	,
11475	,
11730	,
11985	,
12240	,
12495	,
12750	,
13005	,
13260	,
13515	,
13770	,
14025	,
14280	,
14535	,
14790	,
15045	,
15300	,
15555	,
15810	,
16065	,
16320	,
16575	,
16830	,
17085	,
17340	,
17595	,
17850	,
18105	,
18360	,
18615	,
18870	,
19125	,
19380	,
19635	,
19890	,
20145	,
20400	,
20655	,
20910	,
21165	,
21420	,
21675	,
21930	,
22185	,
22440	,
22695	,
22950	,
23205	,
23460	,
23715	,
23970	,
24225	,
24480	,
24735	,
24990	,
25245	,
25500	,
25755	,
26010	,
26265	,
26520	,
26775	,
27030	,
27285	,
27540	,
27795	,
28050	,
28305	,
28560	,
28815	,
29070	,
29325	,
29580	,
29835	,
30090	,
30345	,
30600	,
30855	,
31110	,
31365	,
31620	,
31875	,
32130	,
32385	,
32640	,
32895	,
33150	,
33405	,
33660	,
33915	,
34170	,
34425	,
34680	,
34935	,
35190	,
35445	,
35700	,
35955	,
36210	,
36465	,
36720	,
36975	,
37230	,
37485	,
37740	,
37995	,
38250	,
38505	,
38760	,
39015	,
39270	,
39525	,
39780	,
40035	,
40290	,
40545	,
40800	,
41055	,
41310	,
41565	,
41820	,
42075	,
42330	,
42585	,
42840	,
43095	,
43350	,
43605	,
43860	,
44115	,
44370	,
44625	,
44880	,
45135	,
45390	,
45645	,
45900	,
46155	,
46410	,
46665	,
46920	,
47175	,
47430	,
47685	,
47940	,
48195	,
48450	,
48705	,
48960	,
49215	,
49470	,
49725	,
49980	,
50235	,
50490	,
50745	,
51000	,
51255	,
51510	,
51765	,
52020	,
52275	,
52530	,
52785	,
53040	,
53295	,
53550	,
53805	,
54060	,
54315	,
54570	,
54825	,
55080	,
55335	,
55590	,
55845	,
56100	,
56355	,
56610	,
56865	,
57120	,
57375	,
57630	,
57885	,
58140	,
58395	,
58650	,
58905	,
59160	,
59415	,
59670	,
59925	,
60180	,
60435	,
60690	,
60945	,
61200	,
61455	,
61710	,
61965	,
62220	,
62475	,
62730	,
62985	,
63240	,
63495	,
63750	,
64005	,
64260	,
64515	,
64770	,
65025	,
};

const u16 x1535_table[21] = {
0	,
1535	,
3070	,
4605	,
6140	,
7675	,
9210	,
10745	,
12280	,
13815	,
15350	,
16885	,
18420	,
19955	,
21490	,
23025	,
24560	,
26095	,
27630	,
29165	,
30700	,
};

const u8 delta_a_c_pwm[40][18] = {
111	,	112	,	113	,	114	,	115	,	116	,	117	,	118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	129	,
112	,	113	,	114	,	115	,	116	,	117	,	118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,
112	,	113	,	114	,	115	,	116	,	117	,	118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	130	,
113	,	114	,	115	,	116	,	117	,	118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,
113	,	114	,	115	,	116	,	117	,	118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	131	,
114	,	115	,	116	,	117	,	118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,
114	,	115	,	116	,	117	,	118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	132	,
114	,	116	,	117	,	118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,
115	,	116	,	117	,	118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	133	,
115	,	116	,	117	,	118	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,	133	,
116	,	117	,	118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,	134	,
116	,	117	,	118	,	119	,	120	,	121	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,	133	,	134	,
117	,	118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,	133	,	135	,
117	,	118	,	119	,	120	,	121	,	122	,	123	,	124	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,	133	,	134	,	135	,
118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,	133	,	134	,	136	,
118	,	119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	128	,	129	,	130	,	131	,	132	,	133	,	134	,	135	,	136	,
118	,	119	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,	133	,	134	,	135	,	137	,
119	,	120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	130	,	131	,	132	,	133	,	134	,	135	,	136	,	137	,
119	,	120	,	121	,	122	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,	133	,	134	,	135	,	136	,	138	,
120	,	121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	132	,	133	,	134	,	135	,	136	,	137	,	138	,
120	,	121	,	122	,	123	,	124	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,	133	,	134	,	135	,	136	,	137	,	139	,
121	,	122	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	133	,	134	,	135	,	136	,	137	,	138	,	139	,
121	,	122	,	123	,	124	,	125	,	126	,	128	,	129	,	130	,	131	,	132	,	133	,	134	,	135	,	136	,	137	,	138	,	140	,
121	,	123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,	133	,	135	,	136	,	137	,	138	,	139	,	140	,
122	,	123	,	124	,	125	,	126	,	127	,	128	,	130	,	131	,	132	,	133	,	134	,	135	,	136	,	137	,	138	,	139	,	141	,
122	,	123	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,	133	,	134	,	136	,	137	,	138	,	139	,	140	,	141	,
123	,	124	,	125	,	126	,	127	,	128	,	129	,	130	,	132	,	133	,	134	,	135	,	136	,	137	,	138	,	139	,	140	,	142	,
123	,	124	,	125	,	127	,	128	,	129	,	130	,	131	,	132	,	133	,	134	,	135	,	137	,	138	,	139	,	140	,	141	,	142	,
124	,	125	,	126	,	127	,	128	,	129	,	130	,	131	,	133	,	134	,	135	,	136	,	137	,	138	,	139	,	140	,	141	,	143	,
124	,	125	,	126	,	127	,	129	,	130	,	131	,	132	,	133	,	134	,	135	,	136	,	137	,	139	,	140	,	141	,	142	,	143	,
124	,	126	,	127	,	128	,	129	,	130	,	131	,	132	,	133	,	135	,	136	,	137	,	138	,	139	,	140	,	141	,	142	,	144	,
125	,	126	,	127	,	128	,	129	,	131	,	132	,	133	,	134	,	135	,	136	,	137	,	138	,	140	,	141	,	142	,	143	,	144	,
125	,	126	,	128	,	129	,	130	,	131	,	132	,	133	,	134	,	136	,	137	,	138	,	139	,	140	,	141	,	142	,	143	,	145	,
126	,	127	,	128	,	129	,	130	,	131	,	133	,	134	,	135	,	136	,	137	,	138	,	139	,	141	,	142	,	143	,	144	,	145	,
126	,	127	,	129	,	130	,	131	,	132	,	133	,	134	,	135	,	136	,	138	,	139	,	140	,	141	,	142	,	143	,	144	,	146	,
127	,	128	,	129	,	130	,	131	,	132	,	134	,	135	,	136	,	137	,	138	,	139	,	140	,	142	,	143	,	144	,	145	,	146	,
127	,	128	,	129	,	131	,	132	,	133	,	134	,	135	,	136	,	137	,	139	,	140	,	141	,	142	,	143	,	144	,	145	,	147	,
128	,	129	,	130	,	131	,	132	,	133	,	134	,	136	,	137	,	138	,	139	,	140	,	141	,	142	,	144	,	145	,	146	,	147	,
128	,	129	,	130	,	131	,	133	,	134	,	135	,	136	,	137	,	138	,	140	,	141	,	142	,	143	,	144	,	145	,	146	,	148	,
128	,	130	,	131	,	132	,	133	,	134	,	135	,	137	,	138	,	139	,	140	,	141	,	142	,	143	,	145	,	146	,	147	,	148	,
};

const u8 delta_a_c[256] = {
/*111	,
111	,
111	,
111	,
111	,
112	,
112	,
112	,
112	,
112	,
113	,
113	,
113	,
113	,
113	,
114	,
114	,
114	,
114	,
114	,
115	,
115	,
115	,
115	,
115	,
115	,
116	,
116	,
116	,
116	,
117	,
117	,
117	,
117	,
117	,
118	,
118	,
118	,
118	,
118	,
119	,
119	,
119	,
119	,
119	,
120	,
120	,
120	,
120	,
120	,
121	,
121	,
121	,
121	,
121	,
121	,
122	,
122	,
122	,
122	,
122	,
122	,
122	,
123	,
123	,
123	,
123	,
123	,
123	,
124	,
124	,
124	,
124	,
124	,
124	,
124	,
124	,
125	,
125	,
125	,
125	,
125	,
125	,
125	,
125	,
125	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
125	,
125	,
125	,
125	,
125	,
125	,
125	,
125	,
125	,
124	,
124	,
124	,
124	,
124	,
124	,
124	,
124	,
123	,
123	,
123	,
123	,
123	,
123	,
122	,
122	,
122	,
122	,
122	,
122	,
122	,
121	,
121	,
121	,
121	,
121	,
121	,
120	,
120	,
120	,
120	,
120	,
119	,
119	,
119	,
119	,
119	,
118	,
118	,
118	,
118	,
118	,
117	,
117	,
117	,
117	,
117	,
116	,
116	,
116	,
116	,
115	,
115	,
115	,
115	,
115	,
115	,
114	,
114	,
114	,
114	,
114	,
113	,
113	,
113	,
113	,
113	,
112	,
112	,
112	,
112	,
112	,
111	,
111	,
111	,
111*/
111	,
111	,
111	,
112	,
112	,
112	,
112	,
113	,
113	,
113	,
113	,
114	,
114	,
114	,
114	,
115	,
115	,
115	,
115	,
115	,
116	,
116	,
116	,
116	,
117	,
117	,
117	,
117	,
117	,
118	,
118	,
118	,
118	,
118	,
119	,
119	,
119	,
119	,
119	,
120	,
120	,
120	,
120	,
120	,
121	,
121	,
121	,
121	,
121	,
121	,
122	,
122	,
122	,
122	,
122	,
122	,
122	,
123	,
123	,
123	,
123	,
123	,
123	,
124	,
124	,
124	,
124	,
124	,
124	,
124	,
124	,
125	,
125	,
125	,
125	,
125	,
125	,
125	,
125	,
125	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
128	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
127	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
126	,
125	,
125	,
125	,
125	,
125	,
125	,
125	,
125	,
125	,
124	,
124	,
124	,
124	,
124	,
124	,
124	,
124	,
123	,
123	,
123	,
123	,
123	,
123	,
122	,
122	,
122	,
122	,
122	,
122	,
122	,
121	,
121	,
121	,
121	,
121	,
121	,
120	,
120	,
120	,
120	,
120	,
119	,
119	,
119	,
119	,
119	,
118	,
118	,
118	,
118	,
118	,
117	,
117	,
117	,
117	,
117	,
116	,
116	,
116	,
116	,
115	,
115	,
115	,
115	,
115	,
114	,
114	,
114	,
114	,
113	,
113	,
113	,
113	,
112	,
112	,
112	,
112	,
111	,
111
};


//////
const u8 delta_b[256] = {
111	,
110	,
109	,
108	,
108	,
107	,
106	,
105	,
105	,
104	,
103	,
102	,
101	,
100	,
100	,
99	,
98	,
97	,
96	,
96	,
95	,
94	,
93	,
92	,
91	,
91	,
90	,
89	,
88	,
87	,
87	,
86	,
85	,
84	,
83	,
82	,
81	,
81	,
80	,
79	,
78	,
77	,
76	,
76	,
75	,
74	,
73	,
72	,
71	,
70	,
70	,
69	,
68	,
67	,
66	,
65	,
64	,
63	,
63	,
62	,
61	,
60	,
59	,
58	,
57	,
57	,
56	,
55	,
54	,
53	,
52	,
51	,
50	,
49	,
49	,
48	,
47	,
46	,
45	,
44	,
43	,
42	,
41	,
41	,
40	,
39	,
38	,
37	,
36	,
35	,
34	,
33	,
33	,
32	,
31	,
30	,
29	,
28	,
27	,
26	,
25	,
24	,
24	,
23	,
22	,
21	,
20	,
19	,
18	,
17	,
16	,
15	,
15	,
14	,
13	,
12	,
11	,
10	,
9	,
8	,
7	,
6	,
5	,
5	,
4	,
3	,
2	,
1	,
0	,
1	,
2	,
3	,
4	,
5	,
5	,
6	,
7	,
8	,
9	,
10	,
11	,
12	,
13	,
14	,
15	,
15	,
16	,
17	,
18	,
19	,
20	,
21	,
22	,
23	,
24	,
24	,
25	,
26	,
27	,
28	,
29	,
30	,
31	,
32	,
33	,
33	,
34	,
35	,
36	,
37	,
38	,
39	,
40	,
41	,
41	,
42	,
43	,
44	,
45	,
46	,
47	,
48	,
49	,
49	,
50	,
51	,
52	,
53	,
54	,
55	,
56	,
57	,
57	,
58	,
59	,
60	,
61	,
62	,
63	,
63	,
64	,
65	,
66	,
67	,
68	,
69	,
70	,
70	,
71	,
72	,
73	,
74	,
75	,
76	,
76	,
77	,
78	,
79	,
80	,
81	,
81	,
82	,
83	,
84	,
85	,
86	,
87	,
87	,
88	,
89	,
90	,
91	,
91	,
92	,
93	,
94	,
95	,
96	,
96	,
97	,
98	,
99	,
100	,
100	,
101	,
102	,
103	,
104	,
105	,
105	,
106	,
107	,
108	,
108	,
109	,
110
};



extern PWM_MODE PWM_mode;
u8 delta;
//volatile u16 A_pwm_duty;
//volatile u16 B_pwm_duty;
//volatile u16 C_pwm_duty;
volatile u16 U_pwm_duty;
volatile u16 V_pwm_duty;
volatile u16 W_pwm_duty;
u8 T30,T60i,pwm_T0,pwm_T0dr,pwm_T0_dncount,pwm_T0_upcount;//,rotor_position_back;
s8 pwm_b_flag;
int@near pwm_ver;
u16@near pwm_duty_max;
u8@near pwm_duty_max_8bit;
u16@near hall_ver;
int@near cvt_ver;
int@near dir_ver;
int@near dir_ver_save;
int@near dir_ver_act;
int@near dir_ver_act_save;
int@near dir_ver_delta;
int@near dir_ver_act_delta;

u8@near cvt_ver_high_count;
u8@near cvt_ver_low_count;
u16@near test1;
u16@near test2;
u8@near dir_ver_position;
u8@near dir_ver_position_save;
u8@near six_line_mode;
u8 cvt_ver_add_count;
u8 delta_b_8bit;
u8@near tim2_6_flag;
unsigned long int@near hall_ver_6;
unsigned long int@near hall_ver_3;
u16@near hall_ver_step;

u8@near ph_max_ver;
u8@near ph_max_hall;
u16@near ph_max_pwm_count;
u16@near ph_max;
u8@near bh_hall_table[7] = {0,3,6,2,5,1,4};
u8@near pr_hall_table[7] = {0,5,3,1,6,4,2};
u8@near dir_ver_8bit;
u8@near u_pwm_table[7] = {0,1,0,0,2,2,1};
u8@near v_pwm_table[7] = {0,0,2,1,1,0,2};
u8@near w_pwm_table[7] = {0,2,1,2,0,1,0};
u16@near pwm_table[3];
s8@near pwm_b_table[7] = {0,-1,-1,1,-1,1,1};
u8@near svpwm_rotor_position_table[6] = {3,2,6,4,5,1};
u8@near svpwm_rotor_position;

u16@near ph_1;
u16@near ph_2;
u8@near svpwm_rotor_position_save;

unsigned long int@near hall_ver_log[10];
u8@near log_i;
extern u8 @near cvt_speed_motor;
 extern u8@near ph_max_ver_count;

u8 @near rec_count;
u8 @near rec_count_max;

u16 @near hall_ver_mem;

u16 @near hall_ver_step_act;
u16 @near hall_ver_step_act_old;

u16 @near hall_ver_step_delta;
u8 @near hall_ver_step_delta_sign;
u8 @near hall_ver_step_delta_sign_old;
u8 @near hall_ver_step_delta_I;


u16 @near hall_ver_step_chase;
u16 @near hall_ver_step_chase_I;
u8 @near hall_ver_step_chase_sign;
u8 @near hall_ver_step_chase_sign_old;

u8 @near hall_ver_last;

u8 @near speed_motor_8bit;

u16 @near hall_ver_mem_max;
u8 @near chase_sign_max;

u16@near ph_max_save;
u16@near ph_max_ver_save;
u16@near ph_max_hall_save;


u16@near tim1_cnt;

u16@near tim2_1;
u16@near tim2_2;
u16@near tim2_3;
u16@near tim2_1_save;
u16@near speed_motor4;
u16@near hall_pwm_count4;
u16@near tim2_cap_count;
u16@near tim2_count;
u16@near tim2_speed_count;
u16@near tim2_pwm_count;
u16@near tim2_cap_count_next;
u16@near tim2_count_log[36];
u8@near tim2_count_log_i;
u16@near tim2_speed_count_log[36];
u8@near tim2_speed_count_log_i;
u8@near tim2_speed_count_hall[7];
u16@near tim2_speed_count_6;
u16@near tim2_cap_count_6;
u16@near tim2_count_6;

u16@near hall_pwm_cont_6;
u16@near speed_motor_6;

u8 @near tim2_cap_flag;

u8 @near cdpi_60_out_count;

u16 @near speed_motor_6;
u16 @near speed_motor_6_old;
u16 @near speed_motor_6_delta;

u8 @near speed_motor2_old;
u8 @near speed_motor2_delta;
u8 @near speed_motor2_tab[8];
u8 @near speed_motor2_delta_mod;

u8 @near msp_chg_flag;
u8 @near msp_up_flag;
u8 @near msp_down_flag;
u8 @near msp_up_count;
u8 @near msp_down_count;	
u8 @near motor_ws_flag;

u8 hall_lost_count ;
u8 hall_normal_count ;

u8 @near first_in_flag;
u8 @near first_out_flag;
u8 @near cdpi_count;
u8 @near cdpi_flag;
u16 @near tim2_speed_count_6_delta;
u8 tim2_speed_change_flag;

u16@near hall_count_nohall;

u8@near nohall_speed_high_count;
u16@near nohall_speed_low_count;

u16@near tim2_speed_count_6;
u16@near tim2_speed_count_6_old;
u16@near tim2_speed_count_6_save;

u8 @near tim2_cap_flag_count;

unsigned char CVT_flag;
///////////////////////////////////////////////////////////

void sin_cos()
{
		pwm_duty_max = pwm_duty_on_old;

		/*if(pwm_duty_max > 295)
			pwm_duty_max = 295;
		if(current_limit_pwm_flag == 1)
		{
			if(pwm_duty_max > 254)
				pwm_duty_max = 254;
		}*/
		
		if(pwm_duty_max <= 255)
		{
			pwm_duty_max_8bit = pwm_duty_max;
			delta = (delta_a_c[pwm_ver]*pwm_duty_max_8bit/PWM_QTR);
#ifdef sv_pwm_5step	
			pwm_table[0] = (delta << 1) + 2;
			pwm_table[2] = 2;
#else
			pwm_table[0] = (PWM_PER) + delta;
			pwm_table[2] = (PWM_PER) - delta;
#endif
			if(pwm_b_flag == 1)
			{
#ifdef sv_pwm_5step
				if(pwm_ver <= 127)
				{
					pwm_table[1] = (delta) + (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_QTR + 2;
				}
				else
				{
					pwm_table[1] = (delta) - (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_QTR + 2;
				}
			}
			else
			{
				if(pwm_ver <= 127)
				{
					pwm_table[1] = (delta) - (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_QTR + 2;
				}
				else
				{
					pwm_table[1] = (delta) + (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_QTR + 2;
				}
			}
		}
#else
				if(pwm_ver <= 127)
				{
					pwm_table[1] = (PWM_PER) + (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_QTR;
				}
				else
				{
					pwm_table[1] = (PWM_PER) - (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_QTR;
				}
			}
			else
			{
				if(pwm_ver <= 127)
				{
					pwm_table[1] = (PWM_PER) - (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_QTR;
				}
				else
				{
					pwm_table[1] = (PWM_PER) + (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_QTR;
				}
			}
		}
#endif
		else
		{
			pwm_duty_max_8bit = (pwm_duty_max >> 1);
			delta = delta_a_c_pwm[pwm_duty_max - 256][delta_a_c[pwm_ver] - 111];
			if(delta <= 128)
			{
#ifdef sv_pwm_5step
				pwm_table[0] = (delta << 1) + 2;
				pwm_table[2] = 2;
				if(pwm_b_flag == 1)
				{
					if(pwm_ver <= 127)
					{
						pwm_table[1] = (delta) + (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_PER + 2;
					}
					else
					{
						pwm_table[1] = (delta) - (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_PER + 2;
					}
				}
				else
				{
					if(pwm_ver <= 127)
					{
						pwm_table[1] = (PWM_PER) - (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_PER + 2;
					}
					else
					{
						pwm_table[1] = (PWM_PER) + (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_PER + 2;
					}
				}
#else
				pwm_table[0] = (PWM_PER) + delta;
				pwm_table[2] = (PWM_PER) - delta;
				if(pwm_b_flag == 1)
				{
					if(pwm_ver <= 127)
					{
						pwm_table[1] = (PWM_PER) + (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_PER;
					}
					else
					{
						pwm_table[1] = (PWM_PER) - (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_PER;
					}
				}
				else
				{
					if(pwm_ver <= 127)
					{
						pwm_table[1] = (PWM_PER) - (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_PER;
					}
					else
					{
						pwm_table[1] = (PWM_PER) + (delta_b[pwm_ver]*pwm_duty_max_8bit)/PWM_PER;
					}
				}
#endif
			}
			else
			{
				pwm_table[0] = 256;
				pwm_table[2] = 0;
				if(pwm_b_flag == 1)
				{
					if(pwm_ver <= 127)
					{
						pwm_table[1] = (PWM_PER) + ((delta_b[pwm_ver]*pwm_duty_max_8bit)/delta);
					}
					else
					{
						pwm_table[1] = (PWM_PER) - ((delta_b[pwm_ver]*pwm_duty_max_8bit)/delta);
					}
				}
				else
				{
					if(pwm_ver <= 127)
					{
						pwm_table[1] = (PWM_PER) - ((delta_b[pwm_ver]*pwm_duty_max_8bit)/delta);
					}
					else
					{
						pwm_table[1] = (PWM_PER) + ((delta_b[pwm_ver]*pwm_duty_max_8bit)/delta);
					}
				}
			}
		}
			

	
			
		if(pwm_table[0] > 256)
			pwm_table[0] = 256;
			
		if(pwm_table[1] > 256)
			pwm_table[1] = 256;
			
		if(pwm_table[2] > 256)
			pwm_table[2] = 256;
}

//////////////////////////////////////////////////////////////

void rotor_ver(void)
{
	//cvt_rotor_position = rotor_position;
	
	sv_cvt_ver();
	
	pwm_ver = dir_ver_8bit;
	pwm_b_flag = pwm_b_table[cvt_rotor_position];
	sin_cos();
	
	/*U_pwm_duty =  pwm_table[u_pwm_table[cvt_rotor_position]]; 
	V_pwm_duty =  pwm_table[v_pwm_table[cvt_rotor_position]];  
	W_pwm_duty =  pwm_table[w_pwm_table[cvt_rotor_position]]; 
	*/

	U_pwm_duty    =  pwm_table[u_pwm_table[cvt_rotor_position]]; 
	W_pwm_duty    =  pwm_table[v_pwm_table[cvt_rotor_position]];  
	V_pwm_duty   =  pwm_table[w_pwm_table[cvt_rotor_position]]; 
		
	TIM1_CCR1H = (u8)(U_pwm_duty >> 8);
	TIM1_CCR1L = (u8)U_pwm_duty;
	
	TIM1_CCR2H = (u8)(V_pwm_duty >> 8);
	TIM1_CCR2L = (u8)V_pwm_duty;
	
	TIM1_CCR3H = (u8)(W_pwm_duty >> 8);
	TIM1_CCR3L = (u8)W_pwm_duty;

	SVPWM_PH();
	TIM1_EGR |= 0x20;					//Ë¢ÐÂPWM
	PWM_mode.all_flag = DRIVE_BIT;	
}


void svpwm_ver(void)
{				//1530   == 360 250
	if(tim2_6_flag == 2)
	{
//		hall_ver_step = hall_ver_step_table[tim2_speed_count_6];	//
		if(hall_ver_zero_flag == 1)
		{
			if((first_in_flag == 1)||(cdpi_flag == 0))
			{
				hall_ver_mem_max = 0;
				if(cdpi_flag == 1)
					first_in_flag = 0;
				else
					first_in_flag = 1;
				hall_ver_step_delta = 0;
				hall_ver_step_chase = 0;
				hall_ver_step_chase_I = 0;
				hall_ver = x1535_table[tim2_count_6] / tim2_speed_count_6;
				hall_ver_6 = hall_ver << 8;
				hall_ver_step = hall_ver_step_table[tim2_speed_count_6];
				hall_ver_step_act = hall_ver_step;
			}
			else
			{
				//////////////////////chase calculation
				if(hall_ver_mem < 512)
				{
					hall_ver_step_chase_sign = 1;
					hall_ver_step_chase = hall_ver_mem;	//chase set
				}
				else
				{
					hall_ver_step_chase_sign = 0;
					hall_ver_step_chase = 1535 - hall_ver_mem;	//chase set
				}
				
				hall_ver_last = hall_ver_step_chase;	
				
//				if(hall_ver_last > hall_ver_mem_max)
//					hall_ver_mem_max = hall_ver_last;
				
				if(hall_ver_step_chase > 65)	//CDPI5
				{
					if(cdpi_count > 0)
						cdpi_count --;
					else
						cdpi_flag = 0;
				}
				else
				{
					if(cdpi_count < 5)
						cdpi_count ++;
				} //ash
				
				////////////////////chase PI//////////////////


		/*		if(hall_ver_step_chase_sign_old != hall_ver_step_chase_sign)
				{
					hall_ver_step_chase_I = 0;
				}
				else
				{
					if(hall_ver_step_chase_I < 100)
						hall_ver_step_chase_I += hall_ver_step_chase;
				}
				hall_ver_step_chase_sign_old = hall_ver_step_chase_sign;
		*/
				if(current_average1 < current_adj_table[2])
				{
					if(hall_ver_last < 5)	//CDPI5
						hall_ver_step_chase = hall_ver_step_chase >> 2;	//empty load
					else if(hall_ver_last < 10)
						hall_ver_step_chase = hall_ver_step_chase >> 1;
					else if(hall_ver_last < 15)
						hall_ver_step_chase = hall_ver_step_chase;
					else if(hall_ver_last < 25)
						hall_ver_step_chase = hall_ver_step_chase << 1 ;//+ (hall_ver_step_chase << 1);
					else
						hall_ver_step_chase = hall_ver_step_chase +  (hall_ver_step_chase << 1) ;
				}
				else if(pwm_duty_on_old > 250)
				{
					if(hall_ver_last < 5)
						hall_ver_step_chase = hall_ver_step_chase;	//empty load
					else if(hall_ver_last < 10)
						hall_ver_step_chase = hall_ver_step_chase;
					else if(hall_ver_last < 15)
						hall_ver_step_chase = hall_ver_step_chase << 1;
					else if(hall_ver_last < 25)
						hall_ver_step_chase = hall_ver_step_chase << 2 ;//+ (hall_ver_step_chase << 1);
					else
						hall_ver_step_chase = hall_ver_step_chase << 3;
				}
				else if(pwm_duty_on_old > 220)
				{
					if(hall_ver_last < 5)
						hall_ver_step_chase = hall_ver_step_chase;	//empty load
					else if(hall_ver_last < 10)
						hall_ver_step_chase = hall_ver_step_chase + (hall_ver_step_chase >> 1);
					else if(hall_ver_last < 15)
						hall_ver_step_chase = hall_ver_step_chase + (hall_ver_step_chase << 1);
					else if(hall_ver_last < 25)
						hall_ver_step_chase = (hall_ver_step_chase << 1)+ (hall_ver_step_chase << 2) ;//+ (hall_ver_step_chase << 1);
					else
						hall_ver_step_chase = (hall_ver_step_chase << 2)+ (hall_ver_step_chase << 3);									
				}
				else
				{	
					if(hall_ver_last < 5)
						hall_ver_step_chase = hall_ver_step_chase;	//empty load
					else if(hall_ver_last < 10)
						hall_ver_step_chase = hall_ver_step_chase << 1;
					else if(hall_ver_last < 15)
						hall_ver_step_chase = hall_ver_step_chase << 2;
					else if(hall_ver_last < 25)
						hall_ver_step_chase = hall_ver_step_chase << 3 ;//+ (hall_ver_step_chase << 1);
					else
						hall_ver_step_chase = hall_ver_step_chase << 4;				
				}
				
				speed_motor_8bit = speed_motor_6 >> 4;
				hall_ver_step_chase = hall_ver_step_chase / speed_motor_8bit;	
				
	//			if(hall_ver_last > 40)
	//				hall_ver_step_chase += hall_ver_step_chase >> 3;
		//		else if(hall_ver_last > 20)
		//			hall_ver_step_chase += hall_ver_step_chase >> 5;
		//		else if(hall_ver_last > 15)
		//			hall_ver_step_chase += hall_ver_step_chase >> 6;					
					
		//		hall_ver_step_chase = hall_ver_step_chase + hall_ver_step_chase_I;
				//////////////////////////////////////////////
					
				/////////////////////delta caculation///////////
				hall_ver_step = hall_ver_step_table[tim2_speed_count_6_save];
				
				if(hall_ver_step < hall_ver_step_act)
				{
					hall_ver_step_delta_sign = 1;
					hall_ver_step_delta = hall_ver_step_act - hall_ver_step;
				}
				else
				{
					hall_ver_step_delta_sign = 0;
					hall_ver_step_delta = hall_ver_step - hall_ver_step_act;
				}
				
				hall_ver_step_delta = (hall_ver_step_delta >> 2);// - (hall_ver_step_delta >> 4);
				
				
				///////////////////delta PI////////////////////
				///////////////////////////////////////////////
				if(hall_ver_step_chase_sign == 1)
					hall_ver_step_act -= hall_ver_step_chase;
				else
					hall_ver_step_act += hall_ver_step_chase;
				
				if(hall_ver_step_delta_sign == 1)
					hall_ver_step_act -= hall_ver_step_delta;
				else
					hall_ver_step_act += hall_ver_step_delta;
					
				hall_ver_6 += hall_ver_step_act;
				hall_ver = hall_ver_6 >> 8;					
			}
			hall_ver_zero_flag = 0;
		}
		else
		{
			hall_ver_6 += hall_ver_step_act;
			hall_ver = hall_ver_6 >> 8;
		}
		if(hall_ver > 1535)
		{
			hall_ver_6 -= 392960;
			hall_ver -= 1535;
		}
	
		

		hall_ver_mem = hall_ver;
		
		svpwm_rotor_position = svpwm_rotor_position_table[hall_ver >> 8];
		hall_ver &= 0x00FF;
		
	}		//CDPI3
	else if(tim2_6_flag == 1)
	{
		svpwm_rotor_position = rotor_position;
		/*if(tim2_speed_count >= 4096)
			hall_ver = (tim2_count << 1)/(tim2_speed_count >>7);
		else if(tim2_speed_count >= 2048)
			hall_ver = (tim2_count << 2)/(tim2_speed_count >>6);
		else if(tim2_speed_count >= 1024)
			hall_ver = (tim2_count << 3)/(tim2_speed_count >>5);			
		else if(tim2_speed_count >= 512)
			hall_ver = (tim2_count << 4)/(tim2_speed_count >>4);
		else if(tim2_speed_count >= 256)
			hall_ver = (tim2_count << 5)/(tim2_speed_count >>3);			
		else if(tim2_speed_count >= 128)
			hall_ver = (tim2_count << 6)/(tim2_speed_count >>2);
		else
			hall_ver = (tim2_count*255)/tim2_speed_count;*/
		
		if(tim2_count >= tim2_speed_count)
			hall_ver = 255;
		else
		{
			if(tim2_speed_count <= 255)
			{
				hall_ver = (x255_table[tim2_count])/tim2_speed_count;
			}
			else if(tim2_speed_count <= 511)
			{
				hall_ver = (x255_table[tim2_count >> 1])/(tim2_speed_count >> 1);
			}
			else if(tim2_speed_count <= 1023)
			{
				hall_ver = (x255_table[tim2_count >> 2])/(tim2_speed_count >> 2);
			}
			else if(tim2_speed_count <= 2047)
			{
				hall_ver = (x255_table[tim2_count >> 3])/(tim2_speed_count >> 3);
			}
			else if(tim2_speed_count <= 4095)
			{
				hall_ver = (x255_table[tim2_count >> 4])/(tim2_speed_count >> 4);
			}
			else
			{
				hall_ver = (x255_table[tim2_count >> 5])/(tim2_speed_count >> 5);
			}
		}
	}
	else if(tim2_6_flag == 0)
	{
		svpwm_rotor_position = rotor_position;
		
		if(speed_motor3 <= 255)
		{
			if(hall_pwm_cont < speed_motor3)
				hall_ver = x255_table[hall_pwm_cont] / speed_motor3;
			else
				hall_ver = 255;
		}
		else if(speed_motor3 < 500)
		{
			if(hall_pwm_cont < speed_motor3)
				hall_ver = x255_table[hall_pwm_cont >> 1] / (speed_motor3 >> 1);
			else
				hall_ver = 255;
		}
		else

hall_ver = 128;
	}
	else if(tim2_6_flag == 4)
	{
		if(chall_ver_zero_flag == 1)
		{
			hall_ver = (x1535_table[hall_pwm_cont_3] / speed_motor_3) >> 1;
			//hall_ver = 0;
			svpwm_rotor_position = rotor_position;
			chall_ver_zero_flag = 3;
		}
		else if(chall_ver_zero_flag == 2)
		{
			hall_ver = (x1535_table[hall_pwm_cont_3] / speed_motor_3) >> 1;
			//hall_ver = 768;
			svpwm_rotor_position = rotor_position;
			chall_ver_zero_flag = 4;
		}
		else 
		{
			if(chall_ver_zero_flag == 4)
			{
				hall_ver_3 = hall_ver << 8;// + 196608;
				//hall_ver_3 = 196608;
				hall_ver_step = hall_ver_step_table[speed_motor_3 << 1] >> 2;
				chall_ver_zero_flag = 6;
			}
			else if(chall_ver_zero_flag == 3)
			{
				hall_ver_3 = hall_ver << 8;
				//hall_ver_3 = 0;
				hall_ver_step = hall_ver_step_table[speed_motor_3 << 1] >> 2;
				chall_ver_zero_flag = 5;
			}
			
			hall_ver_3 += hall_ver_step;
			
			hall_ver = hall_ver_3 >> 8;
					
			if(chall_ver_zero_flag == 6)
			{			
				hall_ver += 768;
				if(hall_ver > 1535)
					hall_ver = 1535;
			}
			else if(chall_ver_zero_flag == 5)
			{
				if(hall_ver > 767)
					hall_ver = 767;
			}
			
			svpwm_rotor_position = svpwm_rotor_position_table[hall_ver >> 8];
			hall_ver &= 0x00FF;
		}
		/*hall_ver_log[log_i] = hall_ver;
		if(log_i < 9)
			log_i ++;
		else
			log_i = 0;*/
	}
	else
	{
		if(chall_ver_zero_flag == 1)
		{
			//hall_ver_6 = tim2_count_6;
			//hall_ver_6 = (hall_ver_6*392960)/tim2_speed_count_6;
			hall_ver = x1535_table[hall_pwm_cont_6] / speed_motor_6;
			//hall_ver = hall_ver_6;
			//PA_ODR |= 0x02;
			//PA_ODR &= 0xFD;
			svpwm_rotor_position = 3;
			chall_ver_zero_flag = 2;
		}
		else
		{
			if(chall_ver_zero_flag == 2)
			{
				//hall_ver_step = 392960/tim2_speed_count_6;
				//hall_ver_step = 1571840/tim2_speed_count_6;
				hall_ver_6 = (u16)(hall_ver << 8);
				hall_ver_step = hall_ver_step_table[speed_motor_6] >> 2;
				//hall_ver_zero_flag = 3;
				chall_ver_zero_flag = 0;
				//hall_ver_6 += hall_ver_step;
			}
			/*else if(hall_ver_zero_flag == 3)
			{
				hall_ver_zero_flag = 0;
				hall_ver_6 += hall_ver_step;
			}*/
			
			hall_ver_6 += hall_ver_step;
			
			hall_ver = hall_ver_6 >> 8;
					
					
			if(hall_ver > 1535)
				hall_ver = 1535;

				
			svpwm_rotor_position = svpwm_rotor_position_table[hall_ver >> 8];
			hall_ver &= 0x00FF;
		}
	}
	/*if(cvt_rotor_position == 3)					//CAB		//CBA   0`60
	{
		hall_ver = hall_ver;
	}
	else if(cvt_rotor_position == 2)			//BAC		//ACB   60~120
	{
		hall_ver += 256;
	}
	else if(cvt_rotor_position == 6)			//BCA		//ABC   120~180
	{
		hall_ver += 512;
	}
	else if(cvt_rotor_position == 4)			//CBA		//BAC	180~240
	{
		hall_ver += 768;
	}
	else if(cvt_rotor_position == 5)			//ABC		//BA	240~300
	{
		hall_ver += 1024;
	}
	else if(cvt_rotor_position == 1)			//ACB		//CBA	300~360
	{
		hall_ver += 1280;
	}
	else 
	{
		
	}*/
}

void sv_cvt_ver(void)
{
#ifdef S49
	if(cvt_on_flag == 0)
	{
		if((svpwm_rotor_position_save == 5) && (svpwm_rotor_position == 1))
			ph_1 = ph_current_average1;
		else if((svpwm_rotor_position_save == 3) && (svpwm_rotor_position == 2))
			ph_2 = ph_current_average1;
	}
	else
	{
		if((svpwm_rotor_position_save == 5) && (svpwm_rotor_position == 1))
			ph_1 = ph_current_average1;
		else if((svpwm_rotor_position_save == 3) && (svpwm_rotor_position == 2))
			ph_2 = ph_current_average1 + 40;			
	}
#else
	if(cvt_act_flag == 1)	//CVT_AI
	{
		if((svpwm_rotor_position_save == 6) && (svpwm_rotor_position == 4))
			ph_1 = ph_current_average1;
		else if((svpwm_rotor_position_save == 5) && (svpwm_rotor_position == 1))
		{
//				cvt_add = (cvt_torlance_save >> 1) + (cvt_torlance_save >> 3);///5/8
			ph_2 = ph_current_average1 + cvt_add;	
    }			
	}
	else
	{
		if((svpwm_rotor_position_save == 6) && (svpwm_rotor_position == 4))
			ph_1 = ph_current_average1;
		else if((svpwm_rotor_position_save == 5) && (svpwm_rotor_position == 1))
			ph_2 = ph_current_average1;
	}
#endif
	svpwm_rotor_position_save = svpwm_rotor_position;
	
	if(ph_current_average1 > ph_max)
	{
		ph_max_hall = rotor_position;
		ph_max = ph_current_average1;
		ph_max_pwm_count = hall_pwm_cont;
		ph_max_ver = hall_ver;
	}
	/*if(speed_motor3 < 1000)// && (current_cmd_average1 > 0))
	{
#ifdef S49
		if((rotor_position == 2) && (hall_pwm_cont == 0))			//1,5,4   6,2,3
#else
		if((rotor_position == 1) && (hall_pwm_cont == 0))			//1,5,4   6,2,3		
#endif
		{
			if((pwm_duty_max > 0)&&((current_average1 > current_adj_table[2])||(cvt_act_flag == 0)))	//CVT AI
			{
		//		cvt_change_flag = 2 ;
				if(ph_1 < ph_2)// || ((ph_max < 560) && (speed_motor_6 >= 95) && (cvt_on_flag == 1)))
				{
					cvt_ver_high_count = 0;
					if(cvt_ver < 250)
					{
						if(cvt_ver_low_count < cvt_ver_add_count)
							cvt_ver_low_count ++;
						else
						{
							cvt_ver ++;		
							cvt_ver_low_count = 0;
						}
					}
				}
				else if(ph_1 > ph_2)// || (speed_motor_6 <= 93))
				{
					cvt_ver_low_count = 0;
					if(cvt_ver > -250)
					{
						if(cvt_ver_high_count < cvt_ver_add_count)
							cvt_ver_high_count ++;
						else
						{
							cvt_ver --;
							cvt_ver_high_count = 0;
						}
					}
				}
			}
		 else if(pwm_duty_max > 0)
			{
	//			cvt_change_flag = 1 ;
				if((cvt_reg_flag == 1))
				{
					if(speed_motor_6 > cvt_speed_motor_6)
					{
						cvt_ver_high_count = 0;
						if(cvt_ver < 250)
						{
							if(cvt_ver_low_count < 5)
								cvt_ver_low_count ++;
							else
							{
								cvt_ver ++;		
								cvt_ver_low_count = 0;
							}
						}
					}
					else if(speed_motor_6 < cvt_speed_motor_6)
					{
						cvt_ver_low_count = 0;
						if(cvt_ver > -250)
						{
							if(cvt_ver_high_count < 5)
								cvt_ver_high_count ++;
							else
							{
								cvt_ver --;
								cvt_ver_high_count = 0;
							}
						}
					}
				}
				else
				{
	//				cvt_change_flag = 0 ;
					if(ph_1 < ph_2)// || ((ph_max < 560) && (speed_motor_6 >= 95) && (cvt_on_flag == 1)))
					{
						cvt_ver_high_count = 0;
						if(cvt_ver < 250)
						{
							if(cvt_ver_low_count < cvt_ver_add_count)
								cvt_ver_low_count ++;
							else
							{
								cvt_ver ++;		
								cvt_ver_low_count = 0;
							}
						}
					}
					else if(ph_1 > ph_2)// || (speed_motor_6 <= 93))
					{
						cvt_ver_low_count = 0;
						if(cvt_ver > -250)
						{
							if(cvt_ver_high_count < cvt_ver_add_count)
								cvt_ver_high_count ++;
							else
							{
								cvt_ver --;
								cvt_ver_high_count = 0;
							}
						}
					}					
				}	
			}
			
			ph_max = 0;
		}
	}
	else
	{
		cvt_ver = 0;
	}    */
//cvt_ver = 45;
	cvt_ver_cal();
	
	dir_ver = (s16)(hall_ver + cvt_ver);
	if(dir_ver > 255)
	{
		cvt_rotor_position = bh_hall_table[svpwm_rotor_position];
		dir_ver_8bit = dir_ver;
	}
	else if(dir_ver < 0)
	{
		cvt_rotor_position = pr_hall_table[svpwm_rotor_position];
		dir_ver_8bit = dir_ver + 256;
	}
	else
	{
		cvt_rotor_position = svpwm_rotor_position;
		dir_ver_8bit = dir_ver;
	}
	/*if(dir_ver_count < 20)
		dir_ver_count++;
		else
		{
			dir_ver_count = 0;
			dir_ver++;
	}*/
	/*if(dir_ver >= 1536)				//360
		dir_ver = dir_ver - 1536;	
	else if(dir_ver < 0)
		dir_ver = dir_ver + 1536;*/
	//dir_ver = 384;		//128 = 6, 384 = 4;  640 = 5;	896 = 1;	1152 = 3;	1408 = 2
	
	
	/*if(dir_ver >= dir_ver_save)
		dir_ver_delta = dir_ver - dir_ver_save;
	else
		dir_ver_delta = dir_ver + 1536 - dir_ver_save;

	if(dir_ver_act_delta < dir_ver_delta)
		dir_ver_act_delta ++;
	else if(dir_ver_act_delta > dir_ver_delta)
		dir_ver_act_delta --;
		
	//dir_ver_act_delta = dir_ver_delta;
	dir_ver_act = dir_ver_act + dir_ver_act_delta;
	
	if(dir_ver > dir_ver_act)
		dir_ver_act ++;
	else if(dir_ver < dir_ver_act)
	{
		if((dir_ver < 256) && (dir_ver_act > 1280))
			dir_ver_act ++;
		else
			dir_ver_act --;
	}
	
	if(dir_ver_act >= 1536)				//360
		dir_ver_act = dir_ver_act - 1536;	
	else if(dir_ver_act < 0)
		dir_ver_act = dir_ver_act + 1536;
		
	dir_ver_save = dir_ver;*/
	//if(dir_ver >= dir_ver_act)
		//dir_ver_act = dir_ver;
	//else if((dir_ver < 256) && (dir_ver_act > 1280))
		///dir_ver_act = dir_ver;
}

void hall_read(void)
{
	u8 temp;
	//u8 temp2 = 0;
	
	temp = TIM2_SR1 & 0x0E;
	if(temp > 0)
		tim2_cap_flag = temp;
	
	if(tim2_cap_flag == 0)
	{
		if(tim2_pwm_count < 500)
			tim2_pwm_count ++;
		else
		{
			tim2_speed_count = 5000;
			tim2_speed_count_6 = 5000;
		}
	}
	else
		TIM2_SR1 &= 0xF1;
	
		

if(sys_state_flag.bit.hall_exit == 0)
	{
#ifdef  HALL_60C			//60¶Èr
		rotor_position1 = HALL_60C_table[EHALL_PORT];
#else	
		//rotor_position1 = EHALL_PORT;
		{
			////if(debug_mode_flag == 0)
				// rotor_position1 = 7 - EHALL_PORT;
		//	else
				 rotor_position1 = EHALL_PORT;
		 }
#endif
		if(((rotor_position1 == 0)||(rotor_position1 == 7)))// && (onekey.bit.hall_err_flag == 0))
		{
			if(hall_lost_count > 5)
			{
				error_bank.bit.hall_wron_flag = 1;				//²»ÓÃÎÞHALL×ª»»
				rotor_position = 0;
#ifdef HALL_CHANG_AUTO 				
				sys_state_flag.bit.hall_exit = 1; 				//µ±ÐèÒªÎÞ»ô¶ûÈ´»»Ê±£¬½«´Ë¾äÆôÓÃ
#else			
	#ifdef  ONE_KEY_FUN
				//sys_state_flag.bit.hall_exit = 1;
				if(onekey.err == 0)	
				{
					onekey.bit.hall_err_flag = 1;
					alarm.bit.hall_alm_flag = 1 ;
					sys_state_flag.bit.hall_exit = 1;
					com_start = 0;
				}
				else if(onekey.bit.two_err_flag == 0)
				{
					onekey.err |= 0x0C;
					alarm.onekeypass &= 0xF8;			
					alarm.bit.two_alm_flag = 1;
          sys_state_flag.bit.hall_exit = 1;	
          com_start = 0;					
				}
				else 
				{
					onekey.bit.hall_err_flag = 1;		//
					error_bank.bit.hall_wron_flag = 0;
					work_flag.bit.hall = 1;
					sys_state_flag.bit.hall_exit = 1;
				}
	#endif
#endif
			}
			else
				hall_lost_count ++;
			hall_normal_count = 0;
		}
		else
		{
			if(hall_lost_count > 0)
				hall_lost_count --;
				else
				error_bank.bit.hall_wron_flag  = 0;
		}
	}
	else
	{
//		rotor_position1 = EHALL_PORT;
		rotor_position1 = IHALL_PORT;
#ifdef HALL_CHANG_AUTO 	
      if(hall_change_count > 6000)
		     error_bank.bit.hall_wron_flag = 0;
		else
		     hall_change_count ++;
#endif		
	}
		
	//if(speed_motor3 > 100)
		//temp2 = 1;
//	rotor_position1 = Hall_REV_table[rotor_position1];	
	if((rotor_position1 != rotor_position) && (rotor_position1 != rotor_position2) && ((tim2_cap_flag > 0) || (speed_motor3 >= 500)||((sys_state_flag.bit.hall_exit == 1)&& (hall_pwm_cont > (speed_motor2>> 1)))))
		//if((rotor_position1 == hall_turetable[rotor_position]) && (rotor_position1 != rotor_position2) && ((tim2_cap_flag > 0) || (speed_motor3 >= 500)||((sys_state_flag.bit.hall_exit == 1)&& (hall_pwm_cont > (speed_motor2>> 1)))))
	{
		speed_motor3 = ((speed_motor2 + hall_pwm_cont + hall_pwm_cont + hall_pwm_cont) >> 2);		
		speed_motor2 = hall_pwm_cont + 1;	//CDPI3		
		hall_pwm_cont = 0; //ash
		if((speed_motor2 < 200) && (speed_motor2 > 4))//cl2012.11.27
		{
			if(nohall_speed_high_count < 30)
				nohall_speed_high_count ++;
			else
			{
				ModeFlag = 1;					//Ä£Ê½±êÖ¾
			}
		}
		else
			nohall_speed_high_count = 0;
	/*			rec_count ++;		//CDPI Observe
				if(rec_count == 30)
					rec_count = 0;
				if(rec_count < 10)
				{
					t6_ver_tab[rec_count] = pwm_duty_on_old;
					t6_count_tab[rec_count] = hall_ver_mem;
					t6_ov_tab[rec_count] = current_average1;
					t6_cs_tab[rec_count] = speed_motor_6;
				}
				else if(rec_count < 20)
				{
					t6_ver_tab_2[(rec_count - 10)] = pwm_duty_on_old;
					t6_count_tab_2[(rec_count - 10)] = hall_ver_mem;
					t6_ov_tab_2[(rec_count - 10)] = current_average1;
					t6_cs_tab_2[(rec_count - 10)] = speed_motor_6;
				}
				else
				{
					t6_ver_tab_3[(rec_count - 20)] = pwm_duty_on_old;
					t6_count_tab_3[(rec_count - 20)] = hall_ver_mem;
					t6_ov_tab_3[(rec_count - 20)] = current_average1;
					t6_cs_tab_3[(rec_count - 20)] = speed_motor_6;
				} */
		if(speed_motor2 < 250)	//ash
		{
			if(speed_motor2 > speed_motor2_tab[rotor_position])
				speed_motor2_delta = speed_motor2 - speed_motor2_tab[rotor_position];
			else
				speed_motor2_delta = speed_motor2_tab[rotor_position] - speed_motor2;
	
			speed_motor2_tab[rotor_position] = speed_motor2;
			
			if((tim2_6_flag != 0)&&(current_average1 > current_adj_table[5]))
			{
				if(speed_motor_6 > 400)
				{
					speed_motor2_delta_mod = speed_motor2 >> 3;
					if(speed_motor2_delta > speed_motor2_delta_mod)
					{
						if(cdpi_60_out_count >= 2)
						{
							tim2_6_flag = 0;
							if(cdpi_flag == 1)
								first_out_flag = 1;	
							mode_360_count = 0;
						}
						else
							cdpi_60_out_count ++;
					}
					else
					{
						if(cdpi_60_out_count > 0)
							cdpi_60_out_count --;
					}			
				}
				else if(speed_motor_6 > 300)	//speed_motor2 > 40
				{
					speed_motor2_delta_mod = speed_motor2 >> 2;
					if(speed_motor2_delta > speed_motor2_delta_mod)
					{
						if(cdpi_60_out_count >= 2)	//ash
						{
							tim2_6_flag = 0;
							if(cdpi_flag == 1)
								first_out_flag = 1;	
							mode_360_count = 0;
						}
						else
							cdpi_60_out_count ++;
					}
					else
					{
						if(cdpi_60_out_count > 0)
							cdpi_60_out_count --;
					}
				}			
				else if(speed_motor_6 > 120)	//speed_motor2 > 20
				{
					speed_motor2_delta_mod = (speed_motor2 >> 2) + (speed_motor2 >> 3);
					if(speed_motor2_delta > speed_motor2_delta_mod)
					{
						tim2_6_flag = 0;
						if(cdpi_flag == 1)
							first_out_flag = 1;	
						mode_360_count = 0;
					}
				}
				else
				{
					speed_motor2_delta_mod = speed_motor2 >> 1;
					if(speed_motor2_delta > speed_motor2_delta_mod)
					{
						tim2_6_flag = 0;
						if(cdpi_flag == 1)
							first_out_flag = 1;	
						mode_360_count = 0;
					}
				} 
		/*		if((cdpi_flag == 1)&&(speed_motor2 > 150))
				{
					tim2_6_flag = 0;
					if(cdpi_flag == 1)
						first_out_flag = 1;
					mode_360_count = 0;
				}*/
				
			}
		}
		else
			speed_motor2_tab[rotor_position] = 250;

		if(tim2_cap_flag == 4)
		{
			tim2_2 = TIM2_CCR2H;
			tim2_2 = (tim2_2 << 8) + TIM2_CCR2L;
			//TIM2_SR1 &= 0xFB;
			TIM2_CCER1 ^= 0x20;
			
			if(tim2_2 >= tim2_cap_count)
				tim2_speed_count = tim2_2 - tim2_cap_count;
			else
				tim2_speed_count = 60000 - tim2_cap_count + tim2_2;
				
			tim2_cap_count = tim2_2;
			
			if(rotor_position1 == 3)
			{
				if(tim2_2 >= tim2_cap_count_6)
					tim2_speed_count_6 = tim2_2 - tim2_cap_count_6;
				else
					tim2_speed_count_6 = 60000 - tim2_cap_count_6 + tim2_2;
				
							
		//		tim2_speed_count_6_save = ((tim2_speed_count_6_save << 2) - tim2_speed_count_6_save + (tim2_speed_count_6)) >> 2;
				
				if((msp_up_flag == 1)||(msp_down_flag == 1))	//ash
						tim2_speed_count_6_save = tim2_speed_count_6 + tim2_speed_count_6 - tim2_speed_count_6_old;
	//			}
				else
					tim2_speed_count_6_save = tim2_speed_count_6;//((tim2_speed_count_6_save << 3) - tim2_speed_count_6_save + tim2_speed_count_6) >> 2;
							
					
					
				tim2_speed_count_6_old = tim2_speed_count_6;
		
				
				tim2_cap_count_6 = tim2_2;
				hall_ver_zero_flag = 1;
			}
			
			tim2_pwm_count = 0;
			//temp2 = 1;
		}
		else if(tim2_cap_flag == 8)
		{
			tim2_3 = TIM2_CCR3H;
			tim2_3 = (tim2_3 << 8) + TIM2_CCR3L;
			//TIM2_SR1 &= 0xF7;
			TIM2_CCER2 ^= 0x02;
			
			if(tim2_3 >= tim2_cap_count)
				tim2_speed_count = tim2_3 - tim2_cap_count;
			else
				tim2_speed_count = 60000 - tim2_cap_count + tim2_3;
				
			tim2_cap_count = tim2_3;
			tim2_pwm_count = 0;
			//temp2 = 1;
		}
		else if(tim2_cap_flag == 2)
		{
			//tim2_1_save = tim2_1;
			tim2_1 = TIM2_CCR1H;
			tim2_1 = (tim2_1 << 8) + TIM2_CCR1L;
			//TIM2_SR1 &= 0xFD;
			TIM2_CCER1 ^= 0x02;
			
			if(tim2_1 >= tim2_cap_count)
				tim2_speed_count = tim2_1 - tim2_cap_count;
			else
				tim2_speed_count = 60000 - tim2_cap_count + tim2_1 ;
				
			tim2_cap_count = tim2_1;
			tim2_pwm_count = 0;
			//temp2 = 1;
		}
		
		tim2_cap_flag = 0;
		//TIM2_SR1 &= 0xFB;
		//TIM2_SR1 &= 0xF7;
		//TIM2_SR1 &= 0xFD;
		
		
		
		if(rotor_position1 == 3)
		{
			sys_state_flag2.bit.hall_change = 1;
	/*		if(((tim2_6_flag == 2)&&(hall_ver_mem < 700)&&(hall_ver_mem > 95))||((tim2_6_flag == 2)&&(hall_ver_mem > 700)&&(hall_ver_mem < 1440)))
			{
				mode_360_count = 0;
				if(cdpi_flag == 1)
					first_out_flag = 1;
				tim2_6_flag = 0;					
			}*/ //ash
			if(speed_motor_6 < 400)
			{
				if(mode_360_count >= 10) //ash
				{
					if(tim2_6_flag != 2)
					{
						cdpi_flag = 0;
						cdpi_count = 0;
						tim2_6_flag = 2;		//CDPI3 to improve mode 0
					}	
					else if((hall_ver_mem > 1500)||(hall_ver_mem  < 35))
					{
						if(cdpi_count < 5) //ash
							cdpi_count ++;
						else
						{
							if(cdpi_flag == 0)
							{
								cdpi_flag = 1;
								first_in_flag = 1;
							}
						}
					}
		//			cdpi_flag = 0;	//force no PLL
		//			tim2_6_flag = 0;	//force 60d
				}
				if(motor_flag.all_flag != DRIVE_BIT)
					mode_360_count = 0;
				else if(mode_360_count < 50)
					mode_360_count ++;
			}	
			else if(speed_motor_6 > 450)
			{
					mode_360_count = 0;
					if(tim2_6_flag != 0)
						first_out_flag = 1;
					tim2_6_flag = 0;
			}
	
	//		tim2_6_flag = 0;	//force 60d
			
			speed_motor_6 = hall_pwm_cont_6 + 1;
			hall_pwm_cont_6 = 0;
			chall_ver_zero_flag = 1;
		}
		else
			hall_pwm_cont_6 ++;
			
		if(rotor_position1 == 3)
		{
			speed_motor_3 = hall_pwm_cont_3 + 1;
			hall_pwm_cont_3 = 0;
			chall_ver_zero_flag = 1;
		}
		else if(rotor_position1 == 4)
		{
			speed_motor_3 = hall_pwm_cont_3 + 1;
			hall_pwm_cont_3 = 0;
			chall_ver_zero_flag = 2;
		}
		else
			hall_pwm_cont_3 ++;	
			
		hall_count_nohall ++;
		hall_count += 1;
		cvt_ver_add_count = 1;//100/speed_motor3;
		
		if(speed_motor3 > 100) //xz
			c_offset = 1;
		else if (speed_motor3 > 50)
			c_offset = 1;
		else
			c_offset = 1;
		

		rotor_position2 = rotor_position;
		rotor_position = rotor_position1;
		
#ifdef	SV_PWM

/*		if(speed_motor3 > 250)
		{
			CVT_hall_count = (speed_motor3 >> 1);
		}
		else
			CVT_hall_count = speed_motor3 - CVT_VER[(u8)speed_motor3];//speed_motor2 - (speed_motor2 >> 1);*/
			
		//	CVT_hall_count = speed_motor2;
#else
		if(current_average1 > (current_adj_table[4]))
			sys_state_flag.bit.ph_flag = 1;	
#ifdef AUTO_PHS
		if((current_v < current_adj_table[4]) || (current_average1 < current_adj_table[1]))
			sys_state_flag.bit.ph_flag = 0;	
			
		if(sys_state_flag.bit.ph_flag > 0)
			sys_state_flag.bit.phs_flag = 1;
#else		
		if((sys_state_flag.bit.ph_flag == 0) || (current_v < current_adj_table[4]))
		{
			ph_low_count_max_back = 0;
		}
		else
		{
			if(current_average1 < current_adj_table[1])												//1/8
			{
				ph_low_count_max_back = 0;	
				sys_state_flag.bit.ph_flag = 0;	
			}
			else if(current_average1 < current_adj_table[3])												//2/8
				ph_low_count_max_back = 0;	
			else if(current_average1 < current_adj_table[4])		//3/8
				ph_low_count_max_back = 1;	
			else if(current_average1 < current_adj_table[5])		//5/8
				ph_low_count_max_back = 2;				
			else if(current_average1 < current_adj_table[6])		//5/8
				ph_low_count_max_back = 3;				
			else 				
				ph_low_count_max_back = 4;

			if(ph_current_average > ((PH_CURRENT_MAX) - (PH_CURRENT_MAX >> 3)))						//35a
			{
				ph_low_count_max_back += 4;					//
			}
			else if(ph_current_average > (PH_CURRENT_MAX - (PH_CURRENT_MAX >> 2)))			//30A
			{
				ph_low_count_max_back += 3;
			}
			else if(ph_current_average > ((PH_CURRENT_MAX >>1) + (PH_CURRENT_MAX >> 3)))			//25
			{
				ph_low_count_max_back += 2;
			}
			else if(ph_current_average > (PH_CURRENT_MAX >>1))										//20
			{
				ph_low_count_max_back += 1;
			}

/*
			if(ph_current_average > ((PH_CURRENT_MAX) - (PH_CURRENT_MAX >> 2)))						//30a
			{
				ph_low_count_max_back += 4;					//
			}
			else if(ph_current_average > (PH_CURRENT_MAX >>1))										//20A
			{
				ph_low_count_max_back += 3;
			}
			else if(ph_current_average > (PH_CURRENT_MAX >>2))										//10
			{
				ph_low_count_max_back += 2;
			}
			else if(ph_current_average > (PH_CURRENT_MAX >>3))										//8
			{
				ph_low_count_max_back += 1;
			}
			*/
		}
		
		if(ph_low_count_max > ph_low_count_max_back)
		{
			ph_low_count_max_count ++;
			if(ph_low_count_max_count > 1)
			{
				ph_low_count_max --;
				ph_low_count_max_count = 0;
			}
		}
		else
		{
			ph_low_count_max_count = 0;
			ph_low_count_max = ph_low_count_max_back;
		}
#endif
#endif		
	}
	else
	{

		if(tim2_cap_flag > 0)
		{
			if(tim2_cap_flag_count == 1)
			{
				tim2_cap_flag = 0;
				tim2_cap_flag_count = 0;
			}
			else
				tim2_cap_flag_count = 1;
		}
			
		hall_pwm_cont_3 ++;
		hall_pwm_cont ++;
		hall_pwm_cont_6 ++;
		
		//CDPI5 //ash
		speed_motor2_delta_mod = speed_motor2_tab[rotor_position] + (speed_motor2_tab[rotor_position] >> 2);// + (speed_motor2_tab[rotor_position] >> 3); 
		if(hall_pwm_cont > speed_motor2_delta_mod)
		{
			if(tim2_6_flag == 2)
			{
				tim2_6_flag = 0;
				if(cdpi_flag == 1)
					first_out_flag = 1;	
				mode_360_count = 0;
			}
			else
			{
				mode_360_count = 0;
			}
		}		
		
		if(hall_pwm_cont >= 499)
		{
			hall_pwm_cont = 499;
			speed_motor2 = 500;
			speed_motor3 = 500;
			rotor_position2 = 0;
			hall_drive_back = 0;
			CVT_dep = 0;
			CVT_flag = 0;
			TIM2_SR1 &= 0xF1;
		}
		if(hall_pwm_cont_6 >= 2999)
		{
			hall_pwm_cont_6 = 2999;
			speed_motor_6 = 3000;
		}
	}
	if(speed_motor3 == 500)
		tim2_6_flag = 0;
	
#ifdef CVT_MODE
	if(CVT_flag > 0)
	{
		if(hall_pwm_cont >= CVT_hall_count)
		{
			cvt_rotor_position = hall_turetable[rotor_position];
		}
		else
		{
			cvt_rotor_position = rotor_position;
		}
	}
	else
	{
		cvt_rotor_position = rotor_position;
	}
#endif

//if((rotor_position1 == rotor_position2) || (hall_pwm_cont <= (speed_motor3 >> 1)))
   //tim2_cap_flag = 0;
	

tim2_count = TIM2_CNTRH;

tim2_count = (tim2_count << 8) + TIM2_CNTRL;
	
	tim2_count_6 = tim2_count;
	
	if(tim2_count >= tim2_cap_count)
		tim2_count = tim2_count - tim2_cap_count;
	else
		tim2_count = 60000 - tim2_cap_count + tim2_count;
	
	if(tim2_count_6 >= tim2_cap_count_6)
		tim2_count_6 = tim2_count_6 - tim2_cap_count_6;
	else
		tim2_count_6 = 60000 - tim2_cap_count_6 + tim2_count_6;
		
	if(ModeFlag == 1)
	{
		if((speed_motor2 > 250) || (speed_motor2< 8))//cl2012.11.27
		{
			if(nohall_speed_low_count < 1600)
				nohall_speed_low_count ++;
			else
			{
				ModeFlag = 0;					//Ä£Ê½±êÖ¾
				nohall_speed_high_count = 0;
			}
		}
		else
			nohall_speed_low_count = 0;
	}

}


void msp_change_chk(void)	//CDPI5
{
//u8 @near msp_chg_count;
//u8 @near msp_chg_flag;
//u8 @near msp_up_flag;
	if(sys_state_flag2.bit.hall_change == 1)
	{
		sys_state_flag2.bit.hall_change = 0;
		if(speed_motor_6 > (speed_motor_6_old + 2))
		{
			if(msp_down_flag == 1)
			{
				if(msp_down_count > 0)
					msp_down_count --;
				else
					msp_down_flag = 0;
			}
			else if(msp_up_flag == 0)
			{
				if(msp_up_count < 2)
					msp_up_count ++;
				else
				{
					msp_up_flag = 1;
					msp_down_flag = 0;
					msp_down_count = 0;
					msp_chg_flag = 1;
				}
			}
			else
				msp_down_count = 0;
		}
		else if(speed_motor_6 < (speed_motor_6_old - 2))
		{
			if(msp_up_flag == 1)
			{
				if(msp_up_count > 0)
					msp_up_count --;
				else
					msp_up_flag = 0;
			}
			else if(msp_down_flag == 0)
			{
				if(msp_down_count < 2)
					msp_down_count ++;
				else
				{
					msp_down_flag = 1;
					msp_up_flag = 0;
					msp_up_count = 0;
					msp_chg_flag = 1;
				}
			}
			else
				msp_up_count = 0;
		}
		else
		{
			if(msp_down_count > 0)
				msp_down_count --;
			else
			{
				msp_down_flag = 0;
				msp_chg_flag = 0;
			}
			if(msp_up_count > 0)
				msp_up_count --;
			else
			{
				msp_up_flag = 0;
				msp_chg_flag = 0;
			}
		}	
		speed_motor_6_old = speed_motor_6;
	}
}	

